<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title> ESLCLGGè‹±èªæ‰“å­—ç·´ç¿’ </title>
    
    <!-- æ·»åŠ SheetJSåº«ç”¨æ–¼è™•ç†Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        :root { --primary: #4ecdc4; --secondary: #ff6b6b; --dark: #1a535c; --accent: #ffd166; --p1-color: #ff9f43; --p2-color: #54a0ff; --p3-color: #5f27cd; --chal-color: #2c3e50; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Comic Sans MS', sans-serif; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-x: hidden; overscroll-behavior: none;}
        .container { background-color: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 100%; max-width: 900px; padding: 20px; text-align: center; border: 4px solid #fff; position: relative; }
        h1 { color: var(--dark); margin-bottom: 10px; font-size: 1.8rem; }
        .info-header { display: flex; flex-direction: column; gap: 10px; background-color: #f1f2f6; padding: 10px; border-radius: 12px; margin-bottom: 15px; }
        .player-info { font-size: 1rem; color: var(--dark); font-weight: bold; }
        .game-stats { display: flex; justify-content: center; gap: 10px; font-size: 1.1rem; font-weight: bold; }
        
        .grade-selector { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .grade-btn { padding: 8px 16px; font-size: 1rem; border: none; border-radius: 20px; cursor: pointer; color: white; opacity: 0.6; transition: 0.2s; }
        .grade-btn.p1 { background: var(--p1-color); } 
        .grade-btn.p2 { background: var(--p2-color); } 
        .grade-btn.p3 { background: var(--p3-color); }
        .grade-btn.challenge { background: var(--chal-color); font-weight: bold; border: 2px solid gold; }
        .grade-btn.active { opacity: 1; transform: scale(1.05); outline: 2px solid var(--dark); }
        
        .target-box { background: #fff; border: 3px dashed var(--dark); border-radius: 12px; padding: 15px; margin: 10px 0; min-height: 100px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; font-size: 2rem; font-family: 'Courier New', monospace; word-break: break-word; }
        .char { margin: 0 1px; } 
        .correct { color: var(--primary); } .error-anim { color: var(--secondary); animation: shake 0.3s; } .pending { color: #ccc; }
        
        /* P1 Spelling Styles */
        .scramble-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 15px; min-height: 60px; }
        .scramble-btn { background: #fff; border: 2px solid var(--p1-color); color: var(--dark); font-size: 1.5rem; width: 45px; height: 45px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #ddd; transition: transform 0.1s; }
        .scramble-btn:active { transform: translateY(4px); box-shadow: none; }
        .scramble-btn.used { opacity: 0.3; pointer-events: none; border-color: #ccc; transform: translateY(4px); box-shadow: none; }
        .p1-slot { display: inline-block; width: 30px; height: 40px; border-bottom: 3px solid #ccc; margin: 0 4px; text-align: center; color: var(--dark); }
        .p1-slot.filled { border-color: var(--p1-color); }
        .p1-slot.hint { color: #999; border-color: #eee; }

        #game-input { width: 100%; padding: 10px; font-size: 1.5rem; text-align: center; border: 3px solid #ccc; border-radius: 10px; outline: none; background: #f9f9f9; -webkit-user-select: text; user-select: text; }
        #game-input:focus { border-color: var(--primary); background: #fff; }
        
        .controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; font-size: 1rem; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; }
        .btn-start { background: var(--primary); width: 100%; max-width: 200px; } .btn-reset { background: var(--secondary); } .btn-rank { background: var(--dark); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
        .hidden { display: none !important; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 500px; text-align: center; border: 4px solid var(--accent); position: relative; max-height: 90vh; overflow-y: auto;}
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; -webkit-user-select: text; user-select: text; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; } th { background: #eee; padding: 8px; white-space: nowrap;} td { padding: 8px 4px; border-bottom: 1px solid #eee; }
        
        /* MsDiane Admin Styles */
        .admin-trigger { position: fixed; bottom: 10px; right: 10px; width: 30px; height: 30px; background: rgba(0,0,0,0.1); border-radius: 50%; cursor: pointer; z-index: 9000; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #555; }
        .admin-trigger:hover { background: rgba(0,0,0,0.3); }
        
        .admin-nav { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .admin-tab-btn { flex: 1; padding: 10px; cursor: pointer; background: #f9f9f9; border: none; font-weight: bold; color: #777; }
        .admin-tab-btn.active { background: white; color: var(--dark); border-bottom: 3px solid var(--dark); }
        
        .admin-panel-content { display: none; text-align: left; }
        .admin-panel-content.active { display: block; }
        
        .admin-filter-bar { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; cursor: pointer; border: none; color: white; }
        .btn-del { background: #ff6b6b; } .btn-add { background: #4ecdc4; }
        
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        /* æ–°å¢æ¨£å¼ */
        .rank-checkbox { margin-right: 5px; }
        .bulk-actions { display: flex; gap: 5px; margin-top: 10px; }
        .export-import-section { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .ad-container { margin: 15px 0; padding: 15px; border-radius: 12px; text-align: center; position: relative; }
        .ad-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px; }
        .ad-text { font-size: 1rem; color: #333; margin: 10px 0; }
        .ad-glass { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .heart-icon { cursor: pointer; margin-right: 5px; color: #ccc; transition: transform 0.2s; }
        .heart-icon:hover { transform: scale(1.2); }
        .heart-icon.active { color: #ff6b6b; animation: pulse 0.5s; }
        .comment-bubble { background: #f0f7ff; border-radius: 10px; padding: 8px 12px; margin-top: 5px; font-size: 0.85rem; color: #333; text-align: left; }
        .teacher-comment { font-style: italic; color: #666; font-size: 0.9rem; margin-left: 10px; }
        .like-count { font-size: 0.8rem; color: #666; margin-left: 5px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .ad-preview { border: 2px dashed #ccc; padding: 10px; margin: 10px 0; border-radius: 8px; min-height: 50px; }
        .btn-edit { background: #ffd166; color: #333; }
        .btn-clear { background: #999; }
        .btn-excel { background: #217346; }
        .data-status { background: #e3f2fd; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .excel-notes { font-size: 0.8rem; color: #666; margin-top: 5px; }
        .upload-status { padding: 5px; margin: 5px 0; border-radius: 4px; font-size: 0.8rem; }
        .upload-success { background: #d4edda; color: #155724; }
        .upload-error { background: #f8d7da; color: #721c24; }
        .file-input-label { 
            display: inline-block; 
            padding: 8px 15px; 
            background: #4ecdc4; 
            color: white; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            margin: 5px 0;
        }
        .file-input-label:hover { background: #3dbcb4; }
        .upload-progress { width: 100%; height: 5px; background: #eee; border-radius: 3px; margin: 5px 0; }
        .upload-progress-bar { height: 100%; background: #4ecdc4; border-radius: 3px; transition: width 0.3s; }
    </style>
</head>
<body>

    <div class="admin-trigger" onclick="admin.openLogin()">MsD</div>

    <!-- å»£å‘Šé¡¯ç¤ºå€åŸŸ -->
    <div id="login-ad" class="ad-container hidden"></div>
    <div id="grade-selector-ad" class="ad-container hidden ad-glass"></div>
    <div id="rank-ad" class="ad-container hidden"></div>

    <div class="modal-overlay" id="login-overlay">
        <div class="modal-box">
            <h2 style="color: var(--secondary); margin-bottom: 15px;">ğŸ‘‹ Welcome to my hub</h2>
            <div id="login-ad-inner"></div>
            <input type="text" class="login-input" id="login-class" placeholder="Class: 1A" autocorrect="off">
            <input type="text" class="login-input" id="login-name" placeholder="Name: Diane" autocorrect="off">
            <button class="btn btn-start" id="login-btn" style="margin-top: 15px;">Start</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="admin-login-overlay">
        <div class="modal-box" style="max-width: 300px;">
            <h3>ğŸ”‘ MsDiane Only</h3>
            <input type="password" class="login-input" id="admin-pass" placeholder="Password">
            <button class="btn btn-start" onclick="admin.login()">Login</button>
            <button class="btn" onclick="document.getElementById('admin-login-overlay').classList.add('hidden')" style="background:#ccc; margin-top:5px;">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="admin-dash-overlay">
        <div class="modal-box" style="max-width: 950px; padding: 0; overflow: hidden; display: flex; flex-direction: column; max-height: 95vh;">
            
            <div style="padding: 15px; background: var(--dark); color: white; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; font-size:1.2rem; color:white;">ğŸ› ï¸ Admin Panel</h2>
                <button class="btn-sm" style="background:#444;" onclick="admin.close()">Exit</button>
            </div>

            <div class="admin-nav">
                <button class="admin-tab-btn active" onclick="admin.switchTab('rank')">ğŸ“Š æˆç¸¾ç®¡ç† (Rankings)</button>
                <button class="admin-tab-btn" onclick="admin.switchTab('word')">ğŸ“ å­—åº«ç®¡ç† (Words)</button>
                <button class="admin-tab-btn" onclick="admin.switchTab('ad')">ğŸ“¢ å»£å‘Šç®¡ç† (Ads)</button>
                <button class="admin-tab-btn" onclick="admin.switchTab('feedback')">â¤ï¸ å­¸ç”Ÿå›é¥‹ (Feedback)</button>
            </div>

            <div style="padding: 15px; overflow-y: auto; flex: 1;">
                
                <div id="admin-tab-rank" class="admin-panel-content active">
                    <div class="data-status">
                        <strong>æ•¸æ“šèªªæ˜ï¼š</strong> æ‰€æœ‰æ’åå‡æŒ‰åˆ†æ•¸æ’åºï¼ŒåŒåˆ†ä¸¦åˆ—æ’åï¼ˆå¦‚ï¼š2äººç¬¬1åï¼Œä¸‹ä¸€ä½æ˜¯ç¬¬2åï¼‰ã€‚
                    </div>
                    
                    <div class="admin-filter-bar">
                        <button class="grade-btn p1" onclick="admin.loadRanks('P1')">P1</button>
                        <button class="grade-btn p2" onclick="admin.loadRanks('P2')">P2</button>
                        <button class="grade-btn p3" onclick="admin.loadRanks('P3')">P3</button>
                        <button class="grade-btn challenge" onclick="admin.loadRanks('Challenge')">Chall.</button>
                        <button class="grade-btn" style="background:#333; color:white;" onclick="admin.loadRanks('ALL')">ALL</button>
                    </div>
                    
                    <div class="export-import-section">
                        <div style="display:flex; gap:5px; flex-wrap:wrap;">
                            <button class="btn-sm btn-excel" onclick="admin.exportRanksToExcel()">ğŸ“¥ ä¸‹è¼‰Excel (Export)</button>
                            <button class="btn-sm" style="background:#5f27cd;" onclick="document.getElementById('import-excel-file').click()">ğŸ“¤ ä¸Šå‚³Excel (Import)</button>
                            <input type="file" id="import-excel-file" accept=".xlsx,.xls" style="display:none" onchange="admin.importRanksFromExcel(this)">
                        </div>
                        <div class="excel-notes">æ”¯æ´ .xlsx å’Œ .xls æ ¼å¼ï¼Œéœ€åŒ…å« Grade, Class, Name, Score, Date, Time æ¬„ä½</div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span id="admin-rank-status" style="font-weight:bold; color:#666;">Select a grade</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-sm" style="background:#555;" onclick="admin.selectAllRanks()">å…¨é¸</button>
                            <button class="btn-sm" style="background:#555;" onclick="admin.deselectAllRanks()">å–æ¶ˆå…¨é¸</button>
                            <button class="btn-sm btn-del" onclick="admin.deleteSelectedRanks()">åˆªé™¤é¸ä¸­</button>
                            <button class="btn-sm btn-del" onclick="admin.clearAllRanks()">âš ï¸ æ¸…é™¤æ­¤çµ„æ‰€æœ‰ç´€éŒ„</button>
                        </div>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee;">
                        <table id="admin-rank-table">
                            <thead><tr>
                                <th><input type="checkbox" id="select-all-checkbox" onclick="admin.toggleAllRankCheckboxes(this)"></th>
                                <th>#</th><th>G</th><th>Cls</th><th>Name</th><th>Score</th><th>Date/Time</th><th>Act</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-tab-word" class="admin-panel-content">
                    <div class="admin-filter-bar">
                        <button class="grade-btn p1" onclick="admin.loadWords('P1')">P1 Words</button>
                        <button class="grade-btn p2" onclick="admin.loadWords('P2')">P2 Words</button>
                        <button class="grade-btn p3" onclick="admin.loadWords('P3')">P3 Words</button>
                        <button class="grade-btn challenge" onclick="admin.loadWords('Challenge')">Chall. Words</button>
                    </div>

                    <div style="background:#f0f0f0; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <span id="admin-word-status" style="font-weight:bold; color:var(--dark); display:block; margin-bottom:5px;">Select grade to edit</span>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="new-word-input" class="login-input" placeholder="New word/sentence..." style="margin:0; font-size:0.9rem;">
                            <button class="btn-sm btn-add" onclick="admin.addWord()">Add</button>
                        </div>
                    </div>

                    <div style="max-height: 350px; overflow-y: auto; border: 1px solid #eee;">
                        <table id="admin-word-table">
                            <thead><tr><th>Word / Sentence</th><th>Act</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-tab-ad" class="admin-panel-content">
                    <h3 style="color:var(--dark); margin-bottom:15px;">ğŸ“¢ å»£å‘Šç®¡ç†</h3>
                    
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <h4 style="margin-bottom:10px;">æ–°å¢å»£å‘Š</h4>
                        <div style="margin-bottom:10px;">
                            <select id="ad-position" class="login-input" style="margin:0 0 10px 0;" onchange="admin.updateAdPreview()">
                                <option value="login">ç™»å…¥é é¢ä¸‹æ–¹</option>
                                <option value="grade-selector">å¹´ç´šé¸æ“‡ä¸Šæ–¹ (æ¯›ç»ç’ƒæ•ˆæœ)</option>
                                <option value="rank">æ’åé é¢ä¸‹æ–¹</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom:10px;">
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">å»£å‘Šé¡å‹:</label>
                            <div style="display:flex; gap:10px;">
                                <label><input type="radio" name="ad-type" value="image" checked onclick="admin.toggleAdType()"> åœ–ç‰‡</label>
                                <label><input type="radio" name="ad-type" value="text" onclick="admin.toggleAdType()"> æ–‡å­—</label>
                            </div>
                        </div>
                        
                        <div id="ad-image-input" style="margin-bottom:10px;">
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">ä¸Šå‚³åœ–ç‰‡:</label>
                            <label class="file-input-label" for="ad-image-upload">
                                ğŸ“ é¸æ“‡åœ–ç‰‡æ–‡ä»¶
                            </label>
                            <input type="file" id="ad-image-upload" accept=".jpg,.jpeg,.png,.gif,.webp" style="display:none" onchange="admin.handleImageUpload(this)">
                            <div id="ad-upload-status" class="upload-status"></div>
                            <div id="ad-upload-progress" class="upload-progress" style="display:none;">
                                <div id="ad-upload-progress-bar" class="upload-progress-bar" style="width:0%"></div>
                            </div>
                            <div id="ad-image-preview" style="margin-top:10px;"></div>
                        </div>
                        
                        <div id="ad-text-input" style="margin-bottom:10px; display:none;">
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">å»£å‘Šæ–‡å­—:</label>
                            <textarea id="ad-text-content" class="login-input" rows="3" placeholder="è¼¸å…¥å»£å‘Šæ–‡å­—..." oninput="admin.updateAdPreview()"></textarea>
                        </div>
                        
                        <div style="margin-bottom:10px;">
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">é€£çµ (å¯é¸):</label>
                            <input type="text" id="ad-link" class="login-input" placeholder="https://example.com" style="margin:0;" oninput="admin.updateAdPreview()">
                        </div>
                        
                        <button class="btn-sm btn-add" onclick="admin.saveAd()">ä¿å­˜å»£å‘Š</button>
                    </div>
                    
                    <div class="ad-preview">
                        <h4 style="margin-bottom:10px;">å»£å‘Šé è¦½</h4>
                        <div id="ad-preview-content" style="text-align:center;"></div>
                    </div>
                    
                    <div style="margin-top:20px;">
                        <h4 style="margin-bottom:10px;">ç¾æœ‰å»£å‘Š</h4>
                        <div id="ad-list"></div>
                    </div>
                </div>

                <div id="admin-tab-feedback" class="admin-panel-content">
                    <h3 style="color:var(--dark); margin-bottom:15px;">â¤ï¸ å­¸ç”Ÿå›é¥‹ç®¡ç†</h3>
                    
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <h4 style="margin-bottom:10px;">çµ¦å­¸ç”Ÿé»è®šå’Œç•™è¨€</h4>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="feedback-student-search" class="login-input" placeholder="æœå°‹å­¸ç”Ÿå§“åæˆ–ç­ç´š..." style="margin:0;">
                            <button class="btn-sm" style="background:#555;" onclick="admin.searchStudent()">æœå°‹</button>
                        </div>
                        
                        <div id="student-feedback-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding:10px;"></div>
                    </div>
                    
                    <div style="max-height: 350px; overflow-y: auto; border: 1px solid #eee;">
                        <table id="feedback-table">
                            <thead><tr><th>#</th><th>å­¸ç”Ÿ</th><th>ç­ç´š</th><th>åˆ†æ•¸</th><th>é»è®šæ•¸</th><th>è€å¸«ç•™è¨€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="container">
        <h1>ğŸ« ESLCLGG</h1>
        <div id="grade-selector-ad-container"></div>
        <div class="info-header">
            <div class="player-info">å­¸ç”Ÿ: <span id="display-name">---</span> (<span id="display-class">---</span>)</div>
            <div class="game-stats">
                <div style="background:white;padding:5px 10px;border-radius:8px;">å¾—åˆ† Score: <span id="score">0</span></div>
                <div style="background:white;padding:5px 10px;border-radius:8px;">æ™‚é–“ Time: <span id="timer">60</span>s</div>
            </div>
        </div>
        <div class="grade-selector">
            <button class="grade-btn p1 active" onclick="game.setGrade('P1')">P1 ä¸€å¹´ç´š</button>
            <button class="grade-btn p2" onclick="game.setGrade('P2')">P2 äºŒå¹´ç´š</button>
            <button class="grade-btn p3" onclick="game.setGrade('P3')">P3 ä¸‰å¹´ç´š</button>
            <button class="grade-btn challenge" onclick="game.setGrade('Challenge')">{æŒ‘æˆ°MsDiane}</button>
        </div>
        
        <div class="target-box" id="target-display">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
        
        <div id="p1-interface" class="hidden">
            <div class="scramble-container" id="scramble-box"></div>
        </div>

        <div id="typing-interface" style="margin-top: 15px;">
            <input type="text" id="game-input" placeholder="Type here..." disabled autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>

        <div class="controls">
            <button class="btn btn-start" id="start-btn">é–‹å§‹éŠæˆ² Start</button>
            <button class="btn btn-reset" id="reset-btn" disabled>é‡ç½® Reset</button>
            <button class="btn btn-rank" id="rank-btn">ğŸ† æ’è¡Œæ¦œ Leaderboard</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="rank-overlay">
        <div class="modal-box">
            <h2>ğŸ† æ’è¡Œæ¦œ Leaderboard</h2>
            <div style="margin-bottom:10px; display:flex; justify-content:center; gap:5px; flex-wrap:wrap;" id="rank-tabs">
                <button class="grade-btn p1" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P1')">P1</button>
                <button class="grade-btn p2" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P2')">P2</button>
                <button class="grade-btn p3" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P3')">P3</button>
                <button class="grade-btn challenge" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('Challenge')">Chall.</button>
            </div>
            
            <div id="rank-loading" class="hidden"><div class="spinner"></div></div>
            <div id="rank-msg" style="color:#666; font-size:0.9rem; margin:10px 0;"></div>
            
            <div style="max-height: 250px; overflow-y: auto;">
                <table id="rank-table"><thead><tr><th>#</th><th>Class</th><th>Name</th><th>Score</th><th>Like</th><th>Teacher</th></tr></thead><tbody></tbody></table>
            </div>
            
            <div id="rank-ad-inner" style="margin-top:15px;"></div>
            
            <button class="btn btn-start" style="margin-top: 15px;" onclick="document.getElementById('rank-overlay').classList.add('hidden')">é—œé–‰</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="result-overlay">
        <div class="modal-box">
            <h2>â° æ™‚é–“åˆ°ï¼Time's up</h2>
            <div style="font-size: 3.5rem; color: var(--secondary); margin: 10px 0;" id="final-score">0</div>
            <p id="final-msg" style="margin-bottom: 20px; font-weight:bold;"></p>
            <button class="btn btn-start" onclick="game.closeResult()">æŸ¥çœ‹æ’å</button>
        </div>
    </div>

    <script>
        // ==========================================
        // âœ… Firebase SDK Init
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDU6GWmH-rgvqWvGC45hhqXE_p9wmErxaM",
            authDomain: "typing-1124d.firebaseapp.com",
            databaseURL: "https://typing-1124d-default-rtdb.firebaseio.com",
            projectId: "typing-1124d",
            storageBucket: "typing-1124d.firebasestorage.app",
            messagingSenderId: "869820976054",
            appId: "1:869820976054:web:cda9b912219efff0ee8f17",
            measurementId: "G-PHW409K7M3"
        };

        let dbRef, wordsRef, adsRef, storageRef;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                dbRef = firebase.database().ref('scores');
                wordsRef = firebase.database().ref('words');
                adsRef = firebase.database().ref('ads');
                storageRef = firebase.storage().ref();
                console.log("Firebase initialized successfully!");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const sfx = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            play: function(freqs, type='sine') {
                if (!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = type; o.frequency.setValueAtTime(freqs, this.ctx.currentTime);
                g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime + 0.1);
            },
            correct: function() { this.init(); this.play(800); },
            error: function() { this.init(); this.play(150, 'sawtooth'); },
            success: function() { this.init(); [523,659,784].forEach((f,i)=>setTimeout(()=>this.play(f),i*100)); }
        };

        // ==========================================
        // âœ… Data & Migration Logic
        // ==========================================
        const defaultData = {
            "P1": ["a ball", "a car", "a doll", "a robot", "a bus", "a teddy bear", "red", "blue", "white", "pink"],
            "P2": ["kind", "friendly", "helpful", "clever", "funny", "polite", "in front of", "behind", "between", "because"],
            "P3": ["classroom", "art room", "computer room", "music room", "library", "school hall", "lift", "toilets", "on the left", "on the right", "next to", "Where's", "Where are", "ground floor", "first floor", "second floor", "third floor", "fourth floor", "fifth floor", "sixth floor"],
            "Challenge": ["MsDiane is cool", "English is fun"]
        };

        // ==========================================
        // âœ… æ’åè¨ˆç®—å‡½æ•¸ (ä¿®æ­£ç‰ˆ)
        // ==========================================
        function calculateRanks(records) {
            if (!records || records.length === 0) return [];
            
            // æŒ‰åˆ†æ•¸é™åºæ’åº
            records.sort((a, b) => b.score - a.score);
            
            // è¨ˆç®—æ’å (ä¿®æ­£åŒåˆ†ä¸¦åˆ—æ’å)
            let rank = 1;
            let prevScore = records[0].score;
            let skipCount = 0;
            
            records.forEach((record, index) => {
                if (index > 0) {
                    if (record.score < prevScore) {
                        rank = index + 1 - skipCount;
                        prevScore = record.score;
                    }
                }
                
                record.rank = rank;
                
                // æª¢æŸ¥ä¸‹ä¸€ä½æ˜¯å¦åŒåˆ†
                if (index < records.length - 1 && records[index + 1].score === record.score) {
                    skipCount++;
                } else {
                    skipCount = 0;
                }
            });
            
            return records;
        }

        // ==========================================
        // âœ… Game Logic
        // ==========================================
        const game = {
            data: { "P1": [], "P2": [], "P3": [], "Challenge": [] },
            state: { player: {}, grade: "P1", score: 0, time: 60, playing: false, word: "", currentP1Input: "", timer: null },
            
            init: function() {
                const bind = (id, fn) => document.getElementById(id).onclick = (e) => { e.preventDefault(); fn(); };
                bind('login-btn', () => this.login());
                bind('start-btn', () => this.start());
                bind('reset-btn', () => this.reset());
                bind('rank-btn', () => this.showRank(this.state.grade));
                document.getElementById('game-input').oninput = (e) => this.input(e);
                
                this.checkAndMigrateWords();
                this.loadAds();
                this.setGrade('P1');
            },

            checkAndMigrateWords: function() {
                if(!wordsRef) return;
                wordsRef.once('value', snapshot => {
                    if(!snapshot.exists()) {
                        wordsRef.child('P1').set(defaultData.P1); 
                        wordsRef.child('P2').set(defaultData.P2);
                        wordsRef.child('P3').set(defaultData.P3);
                        wordsRef.child('Challenge').set(defaultData.Challenge);
                    }
                    this.listenToWords();
                });
            },

            listenToWords: function() {
                ['P1', 'P2', 'P3', 'Challenge'].forEach(g => {
                    wordsRef.child(g).on('value', snap => {
                        const val = snap.val();
                        if (!val) {
                            this.data[g] = []; 
                        } else if (Array.isArray(val)) {
                            this.data[g] = val; 
                        } else {
                            this.data[g] = Object.values(val);
                        }
                    });
                });
            },
            
            login: function() {
                const c = document.getElementById('login-class').value.trim();
                const n = document.getElementById('login-name').value.trim();
                if(!c || !n) return alert("è«‹è¼¸å…¥ç­åˆ¥å’Œå§“å Input class and name");
                sfx.correct();
                this.state.player = {c, n};
                document.getElementById('display-name').innerText = n;
                document.getElementById('display-class').innerText = c;
                document.getElementById('login-overlay').classList.add('hidden');
            },

            setGrade: function(g) {
                if(this.state.playing) return;
                this.state.grade = g;
                
                document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('active'));
                const btn = Array.from(document.querySelectorAll('.grade-selector .grade-btn')).find(b => b.innerText.includes(g) || (g==='Challenge' && b.classList.contains('challenge')));
                if(btn) btn.classList.add('active');
                
                if (g === 'P1') {
                    document.getElementById('typing-interface').classList.add('hidden');
                    document.getElementById('p1-interface').classList.remove('hidden');
                } else {
                    document.getElementById('typing-interface').classList.remove('hidden');
                    document.getElementById('p1-interface').classList.add('hidden');
                }
                
                document.getElementById('target-display').innerText = `${g === 'Challenge' ? 'Challenge MsDiane' : g} Get ready`;
            },

            start: function() {
                if(this.state.playing) return;
                sfx.init();
                this.state.playing = true; this.state.score = 0; this.state.time = 60;
                document.getElementById('score').innerText = 0;
                
                document.getElementById('game-input').disabled = false;
                document.getElementById('game-input').value = '';
                if(this.state.grade !== 'P1') document.getElementById('game-input').focus();
                
                document.getElementById('start-btn').disabled = true;
                document.getElementById('reset-btn').disabled = false;
                
                this.next();
                this.state.timer = setInterval(() => {
                    this.state.time--;
                    document.getElementById('timer').innerText = this.state.time;
                    if(this.state.time<=0) this.end();
                }, 1000);
            },

            reset: function() {
                clearInterval(this.state.timer);
                this.state.playing = false;
                document.getElementById('game-input').disabled = true;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('reset-btn').disabled = true;
                document.getElementById('timer').innerText = 60;
                document.getElementById('target-display').innerText = "æº–å‚™ Get Ready";
                document.getElementById('scramble-box').innerHTML = "";
            },

            next: function() {
                const list = this.data[this.state.grade];
                const pool = (list && list.length > 0) ? list : defaultData[this.state.grade] || ["Loading..."];
                
                this.state.word = pool[Math.floor(Math.random()*pool.length)];
                
                if (this.state.grade === 'P1') {
                    this.state.currentP1Input = this.state.word.charAt(0);
                    this.renderP1();
                } else {
                    this.render("");
                }
            },

            renderP1: function() {
                let slotsHtml = "";
                const cleanWord = this.state.word;
                
                for(let i=0; i<cleanWord.length; i++) {
                    const char = cleanWord[i];
                    if(char === ' ') {
                        slotsHtml += `<span style="display:inline-block;width:15px;"></span>`;
                    } else if (i === 0) {
                        slotsHtml += `<span class="p1-slot filled hint">${char}</span>`;
                    } else {
                        slotsHtml += `<span class="p1-slot"></span>`;
                    }
                }
                document.getElementById('target-display').innerHTML = slotsHtml;
                
                const container = document.getElementById('scramble-box');
                container.innerHTML = "";
                
                let chars = this.state.word.slice(1).split('').filter(c => c !== ' ').sort(() => Math.random() - 0.5);
                
                chars.forEach((char) => {
                    const btn = document.createElement('button');
                    btn.className = 'scramble-btn';
                    btn.innerText = char;
                    btn.onclick = () => this.handleP1Click(char, btn);
                    container.appendChild(btn);
                });
            },

            handleP1Click: function(char, btnElem) {
                if(!this.state.playing) return;
                
                const targetNoSpaces = this.state.word.replace(/ /g, '');
                const currentInputLen = this.state.currentP1Input.length;
                
                if(currentInputLen >= targetNoSpaces.length) return; 

                const expectedChar = targetNoSpaces[currentInputLen];
                
                if(char === expectedChar) {
                    sfx.correct();
                    this.state.currentP1Input += char;
                    btnElem.classList.add('used');
                    
                    const slots = document.querySelectorAll('.p1-slot:not(.hint)');
                    for(let s of slots) {
                        if(!s.innerText) {
                            s.innerText = char;
                            s.classList.add('filled');
                            s.classList.add('correct');
                            break;
                        }
                    }

                    if(this.state.currentP1Input === targetNoSpaces) {
                        this.state.score += 10;
                        document.getElementById('score').innerText = this.state.score;
                        sfx.success();
                        setTimeout(() => this.next(), 500);
                    }
                } else {
                    sfx.error();
                    btnElem.classList.add('error-anim');
                    setTimeout(() => btnElem.classList.remove('error-anim'), 300);
                }
            },

            render: function(val) {
                let h = "";
                for(let i=0; i<this.state.word.length; i++) {
                    let c = this.state.word[i];
                    let cls = "pending";
                    if(i < val.length) cls = val[i]===c ? "correct" : "error-anim";
                    h += `<span class="char ${cls}" style="${c===' '?'margin:0 5px;border-bottom:2px solid #ccc;width:10px;display:inline-block':''}">${c===' '?'':c}</span>`;
                }
                document.getElementById('target-display').innerHTML = h;
            },

            input: function(e) {
                if(!this.state.playing) return;
                const v = e.target.value;
                const t = this.state.word;
                if(e.inputType && e.inputType.includes('delete')) return this.render(v);
                if(v.length === 0) return this.render("");
                
                const idx = v.length - 1;
                if(idx >= t.length || v[idx] !== t[idx]) {
                    sfx.error();
                    e.target.value = v.slice(0, -1);
                    document.getElementById('target-display').classList.add('error-anim');
                    setTimeout(()=>document.getElementById('target-display').classList.remove('error-anim'), 300);
                } else {
                    sfx.correct();
                    this.render(v);
                    if(v === t) {
                        this.state.score += 10;
                        document.getElementById('score').innerText = this.state.score;
                        sfx.success();
                        setTimeout(() => { e.target.value=""; this.next(); }, 150);
                    }
                }
            },

            end: function() {
                clearInterval(this.state.timer);
                this.state.playing = false;
                document.getElementById('game-input').disabled = true;
                
                this.save();
                
                document.getElementById('final-score').innerText = this.state.score;
                document.getElementById('final-msg').innerText = `${this.state.player.n} | Good Job!`;
                document.getElementById('result-overlay').classList.remove('hidden');
            },

            save: function() {
                if(!dbRef) return;
                const now = new Date();
                dbRef.push({
                    grade: this.state.grade,
                    name: this.state.player.n,
                    class: this.state.player.c,
                    score: this.state.score,
                    date: `${now.getMonth()+1}/${now.getDate()}`,
                    time: `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    likes: 0,
                    teacherComment: ""
                });
            },

            showRank: function(grade) {
                document.getElementById('rank-overlay').classList.remove('hidden');
                document.querySelector('#rank-table tbody').innerHTML = "";
                document.getElementById('rank-loading').classList.remove('hidden');
                document.getElementById('rank-msg').innerText = "";
                
                document.querySelectorAll('#rank-tabs .grade-btn').forEach(b => b.classList.remove('active'));
                const targetBtn = Array.from(document.querySelectorAll('#rank-tabs .grade-btn')).find(b => b.innerText.includes(grade) || (grade === 'Challenge' && b.classList.contains('challenge')));
                if(targetBtn) targetBtn.classList.add('active');
                
                if(!dbRef) return;

                // ç²å–è©²å¹´ç´šæ‰€æœ‰è¨˜éŒ„
                dbRef.orderByChild('grade').equalTo(grade).once('value')
                .then((snapshot) => {
                    let records = [];
                    snapshot.forEach((child) => { 
                        const data = child.val();
                        data.key = child.key;
                        records.push(data); 
                    });
                    
                    // è¨ˆç®—æ’åï¼ˆä½¿ç”¨ä¿®æ­£çš„æ’åç®—æ³•ï¼‰
                    const rankedRecords = calculateRanks(records);
                    
                    document.getElementById('rank-loading').classList.add('hidden');
                    if(rankedRecords.length === 0) {
                        document.getElementById('rank-msg').innerText = `${grade} æš«ç„¡ç´€éŒ„`;
                    } else {
                        rankedRecords.forEach((r, i) => {
                            if(i >= 50) return; // åªé¡¯ç¤ºå‰50å
                            
                            let icon;
                            if (r.rank === 1) icon = 'ğŸ¥‡';
                            else if (r.rank === 2) icon = 'ğŸ¥ˆ';
                            else if (r.rank === 3) icon = 'ğŸ¥‰';
                            else icon = r.rank;
                            
                            let color = r.rank===1?'gold':r.rank===2?'silver':r.rank===3?'#cd7f32':'#555';
                            
                            // é»è®šé¡¯ç¤º
                            const likeIcon = r.likes > 0 ? 
                                `<span class="heart-icon active">â¤ï¸</span>` : 
                                `<span class="heart-icon">ğŸ¤</span>`;
                            
                            const likeCount = r.likes > 0 ? `<span class="like-count">${r.likes}</span>` : '';
                            const teacherComment = r.teacherComment ? `<div class="comment-bubble">${r.teacherComment}</div>` : '';
                            
                            let row = `<tr>
                                <td style="color:${color};font-weight:bold;">${icon}</td>
                                <td>${r.class}</td>
                                <td>${r.name}</td>
                                <td style="color:var(--primary);font-weight:bold;">${r.score}</td>
                                <td>${likeIcon}${likeCount}</td>
                                <td>${teacherComment}</td>
                            </tr>`;
                            document.querySelector('#rank-table tbody').innerHTML += row;
                        });
                    }
                });
            },

            closeResult: function() {
                document.getElementById('result-overlay').classList.add('hidden');
                this.showRank(this.state.grade);
                this.reset();
            },
            
            loadAds: function() {
                if(!adsRef) return;
                
                adsRef.on('value', snapshot => {
                    if(!snapshot.exists()) return;
                    
                    const ads = snapshot.val();
                    
                    // ç™»å…¥é é¢å»£å‘Š
                    const loginAd = Object.values(ads).find(ad => ad.position === 'login');
                    if(loginAd) {
                        const adHtml = this.createAdHtml(loginAd);
                        document.getElementById('login-ad-inner').innerHTML = adHtml;
                    }
                    
                    // å¹´ç´šé¸æ“‡ä¸Šæ–¹å»£å‘Š
                    const gradeAd = Object.values(ads).find(ad => ad.position === 'grade-selector');
                    if(gradeAd) {
                        const adHtml = this.createAdHtml(gradeAd);
                        document.getElementById('grade-selector-ad-container').innerHTML = adHtml;
                        document.getElementById('grade-selector-ad').classList.remove('hidden');
                    } else {
                        document.getElementById('grade-selector-ad').classList.add('hidden');
                    }
                    
                    // æ’åé é¢å»£å‘Š
                    const rankAd = Object.values(ads).find(ad => ad.position === 'rank');
                    if(rankAd) {
                        const adHtml = this.createAdHtml(rankAd);
                        document.getElementById('rank-ad-inner').innerHTML = adHtml;
                        document.getElementById('rank-ad').classList.remove('hidden');
                    } else {
                        document.getElementById('rank-ad').classList.add('hidden');
                    }
                });
            },
            
            createAdHtml: function(ad) {
                let html = '';
                if(ad.type === 'image' && ad.imageUrl) {
                    html = `<img src="${ad.imageUrl}" class="ad-image" alt="å»£å‘Š" style="max-width:100%;">`;
                } else if(ad.type === 'text' && ad.text) {
                    html = `<div class="ad-text">${ad.text}</div>`;
                }
                
                if(ad.link) {
                    html = `<a href="${ad.link}" target="_blank" style="display:block;">${html}</a>`;
                }
                
                return html;
            }
        };
        
        // ==========================================
        // âœ… Admin Logic (MsDiane)
        // ==========================================
        const admin = {
            currentRankGrade: 'P1',
            currentWordGrade: 'P1',
            selectedRanks: new Set(),
            uploadedImageUrl: null,
            
            openLogin: function() {
                document.getElementById('admin-login-overlay').classList.remove('hidden');
                document.getElementById('admin-pass').value = '';
                document.getElementById('admin-pass').focus();
            },
            login: function() {
                const p = document.getElementById('admin-pass').value;
                if(p === "KliO199868") {
                    document.getElementById('admin-login-overlay').classList.add('hidden');
                    document.getElementById('admin-dash-overlay').classList.remove('hidden');
                    this.switchTab('rank');
                    this.loadRanks('P1');
                } else {
                    alert("Access Denied");
                }
            },
            close: function() {
                document.getElementById('admin-dash-overlay').classList.add('hidden');
            },
            
            switchTab: function(tabName) {
                document.querySelectorAll('.admin-panel-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.admin-tab-btn').forEach(el => el.classList.remove('active'));
                
                document.getElementById(`admin-tab-${tabName}`).classList.add('active');
                const btns = document.querySelectorAll('.admin-tab-btn');
                btns.forEach((btn, index) => {
                    if(btn.textContent.includes(tabName)) btn.classList.add('active');
                });
                
                if(tabName === 'word') {
                    this.loadWords('P1');
                } else if(tabName === 'ad') {
                    this.loadAds();
                } else if(tabName === 'feedback') {
                    this.loadFeedback();
                }
            },

            loadRanks: function(grade) {
                this.currentRankGrade = grade;
                this.selectedRanks.clear();
                document.getElementById('admin-rank-status').innerText = `Viewing: ${grade} (æŒ‰åˆ†æ•¸æ’å)`;
                const tbody = document.querySelector('#admin-rank-table tbody');
                tbody.innerHTML = '<tr><td colspan="9"><div class="spinner" style="width:20px;height:20px;border-width:2px;margin:5px auto;"></div></td></tr>';
                
                let query;
                if(grade === 'ALL') {
                    query = dbRef; 
                } else {
                    query = dbRef.orderByChild('grade').equalTo(grade);
                }

                query.once('value', snap => {
                    tbody.innerHTML = "";
                    if(!snap.exists()) { tbody.innerHTML = "<tr><td colspan='9'>No data</td></tr>"; return; }
                    
                    let data = [];
                    snap.forEach(c => {
                        const val = c.val();
                        if(val && val.name && val.score !== undefined) {
                            if(grade === 'ALL' || val.grade === grade) {
                                data.push({key: c.key, ...val});
                            }
                        }
                    });
                    
                    // æŒ‰åˆ†æ•¸æ’åï¼ˆä½¿ç”¨ä¿®æ­£çš„æ’åç®—æ³•ï¼‰
                    const rankedData = calculateRanks(data);
                    
                    rankedData.forEach(r => {
                        const tr = document.createElement('tr');
                        const dt = `${r.date || '-'} ${r.time || ''}`;
                        
                        tr.innerHTML = `
                            <td><input type="checkbox" class="rank-checkbox" value="${r.key}" onchange="admin.toggleRankSelection('${r.key}', this)"></td>
                            <td style="color:${r.rank===1?'gold':r.rank===2?'silver':r.rank===3?'#cd7f32':'#555'}">${r.rank}</td>
                            <td>${r.grade}</td>
                            <td>${r.class}</td>
                            <td>${r.name}</td>
                            <td>${r.score}</td>
                            <td style="font-size:0.8rem;color:#666;">${dt}</td>
                            <td>
                                <button class="btn-sm btn-del" onclick="admin.delRank('${r.key}')">X</button>
                            </td>`;
                        tbody.appendChild(tr);
                    });
                });
            },
            
            toggleRankSelection: function(key, checkbox) {
                if(checkbox.checked) {
                    this.selectedRanks.add(key);
                } else {
                    this.selectedRanks.delete(key);
                }
            },
            
            toggleAllRankCheckboxes: function(masterCheckbox) {
                const checkboxes = document.querySelectorAll('.rank-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = masterCheckbox.checked;
                    if(masterCheckbox.checked) {
                        this.selectedRanks.add(cb.value);
                    } else {
                        this.selectedRanks.delete(cb.value);
                    }
                });
            },
            
            selectAllRanks: function() {
                const checkboxes = document.querySelectorAll('.rank-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    this.selectedRanks.add(cb.value);
                });
            },
            
            deselectAllRanks: function() {
                const checkboxes = document.querySelectorAll('.rank-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    this.selectedRanks.delete(cb.value);
                });
            },
            
            deleteSelectedRanks: function() {
                if(this.selectedRanks.size === 0) {
                    alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è¨˜éŒ„");
                    return;
                }
                
                if(confirm(`ç¢ºå®šè¦åˆªé™¤ ${this.selectedRanks.size} æ¢è¨˜éŒ„å—ï¼Ÿ`)) {
                    const updates = {};
                    this.selectedRanks.forEach(key => {
                        updates[key] = null;
                    });
                    
                    dbRef.update(updates).then(() => {
                        alert("åˆªé™¤æˆåŠŸï¼");
                        this.selectedRanks.clear();
                        this.loadRanks(this.currentRankGrade);
                    });
                }
            },
            
            delRank: function(key) {
                if(confirm("Confirm delete?")) {
                    dbRef.child(key).remove().then(() => this.loadRanks(this.currentRankGrade));
                }
            },
            clearAllRanks: function() {
                if(confirm(`âš ï¸ WARNING: DELETE ALL ${this.currentRankGrade} records? This cannot be undone.`)) {
                    const grade = this.currentRankGrade;
                    if (grade === 'ALL') {
                         if(confirm("REALLY delete EVERYTHING (All Grades)?")) {
                             dbRef.remove().then(() => { alert("Cleared DB."); this.loadRanks('ALL'); });
                         }
                    } else {
                        dbRef.orderByChild('grade').equalTo(grade).once('value', snap => {
                            const updates = {};
                            snap.forEach(c => updates[c.key] = null);
                            dbRef.update(updates).then(() => {
                                alert("Cleared.");
                                this.loadRanks(grade);
                            });
                        });
                    }
                }
            },
            
            exportRanksToExcel: function() {
                let query;
                if(this.currentRankGrade === 'ALL') {
                    query = dbRef;
                } else {
                    query = dbRef.orderByChild('grade').equalTo(this.currentRankGrade);
                }
                
                query.once('value').then(snap => {
                    const data = [];
                    let records = [];
                    
                    snap.forEach(child => {
                        const val = child.val();
                        if(val && val.name) {
                            records.push(val);
                        }
                    });
                    
                    // è¨ˆç®—æ’å
                    const rankedRecords = calculateRanks(records);
                    
                    rankedRecords.forEach(r => {
                        data.push({
                            'æ’å': r.rank,
                            'å¹´ç´š': r.grade || '',
                            'ç­ç´š': r.class || '',
                            'å§“å': r.name || '',
                            'åˆ†æ•¸': r.score || 0,
                            'æ—¥æœŸ': r.date || '',
                            'æ™‚é–“': r.time || '',
                            'é»è®šæ•¸': r.likes || 0,
                            'è€å¸«ç•™è¨€': r.teacherComment || '',
                            'æ™‚é–“æˆ³': r.timestamp ? new Date(r.timestamp).toLocaleString() : ''
                        });
                    });
                    
                    // å‰µå»ºExcelå·¥ä½œè¡¨
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "æˆç¸¾æ’å");
                    
                    // ç”ŸæˆExcelæ–‡ä»¶
                    const fileName = `ranking_${this.currentRankGrade}_${new Date().toISOString().slice(0,10)}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                });
            },
            
            importRanksFromExcel: function(input) {
                const file = input.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        if(!Array.isArray(jsonData) || jsonData.length === 0) {
                            alert("Excelæ–‡ä»¶ä¸­æ²’æœ‰æ•¸æ“š");
                            return;
                        }
                        
                        // æª¢æŸ¥å¿…è¦æ¬„ä½
                        const firstRow = jsonData[0];
                        const requiredFields = ['å¹´ç´š', 'ç­ç´š', 'å§“å', 'åˆ†æ•¸'];
                        const missingFields = requiredFields.filter(field => !(field in firstRow));
                        
                        if(missingFields.length > 0) {
                            alert(`Excelæ–‡ä»¶ç¼ºå°‘å¿…è¦æ¬„ä½: ${missingFields.join(', ')}`);
                            return;
                        }
                        
                        if(confirm(`å°‡å°å…¥ ${jsonData.length} æ¢è¨˜éŒ„ï¼Œç¹¼çºŒå—ï¼Ÿ`)) {
                            let imported = 0;
                            jsonData.forEach(record => {
                                if(record['å§“å'] && record['åˆ†æ•¸'] !== undefined) {
                                    const now = new Date();
                                    dbRef.push({
                                        grade: record['å¹´ç´š'] || this.currentRankGrade,
                                        name: record['å§“å'],
                                        class: record['ç­ç´š'],
                                        score: Number(record['åˆ†æ•¸']) || 0,
                                        date: record['æ—¥æœŸ'] || `${now.getMonth()+1}/${now.getDate()}`,
                                        time: record['æ™‚é–“'] || `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
                                        likes: Number(record['é»è®šæ•¸']) || 0,
                                        teacherComment: record['è€å¸«ç•™è¨€'] || '',
                                        timestamp: firebase.database.ServerValue.TIMESTAMP
                                    });
                                    imported++;
                                }
                            });
                            
                            setTimeout(() => {
                                alert(`æˆåŠŸå°å…¥ ${imported} æ¢è¨˜éŒ„ï¼`);
                                this.loadRanks(this.currentRankGrade);
                            }, 1000);
                        }
                    } catch (error) {
                        alert("æ–‡ä»¶è®€å–éŒ¯èª¤: " + error.message);
                        console.error(error);
                    }
                    input.value = '';
                };
                reader.readAsArrayBuffer(file);
            },
            
            // åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
            handleImageUpload: function(input) {
                const file = input.files[0];
                if(!file) return;
                
                // æª¢æŸ¥æ–‡ä»¶é¡å‹
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if(!validTypes.includes(file.type)) {
                    document.getElementById('ad-upload-status').innerHTML = 
                        '<div class="upload-error">åªæ”¯æ´ JPG, PNG, GIF, WEBP æ ¼å¼</div>';
                    return;
                }
                
                // æª¢æŸ¥æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§2MBï¼‰
                if(file.size > 2 * 1024 * 1024) {
                    document.getElementById('ad-upload-status').innerHTML = 
                        '<div class="upload-error">åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é2MB</div>';
                    return;
                }
                
                // é¡¯ç¤ºä¸Šå‚³é€²åº¦
                const progressBar = document.getElementById('ad-upload-progress-bar');
                const progressContainer = document.getElementById('ad-upload-progress');
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                
                document.getElementById('ad-upload-status').innerHTML = 
                    '<div>ä¸Šå‚³ä¸­...</div>';
                
                // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
                const fileName = `ads/${Date.now()}_${file.name}`;
                const storageRef = firebase.storage().ref(fileName);
                
                // ä¸Šå‚³æ–‡ä»¶
                const uploadTask = storageRef.put(file);
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // æ›´æ–°é€²åº¦
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                    },
                    (error) => {
                        // ä¸Šå‚³å¤±æ•—
                        progressContainer.style.display = 'none';
                        document.getElementById('ad-upload-status').innerHTML = 
                            `<div class="upload-error">ä¸Šå‚³å¤±æ•—: ${error.message}</div>`;
                        console.error('Upload error:', error);
                    },
                    () => {
                        // ä¸Šå‚³æˆåŠŸï¼Œç²å–ä¸‹è¼‰URL
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            progressContainer.style.display = 'none';
                            this.uploadedImageUrl = downloadURL;
                            
                            // é¡¯ç¤ºåœ–ç‰‡é è¦½
                            document.getElementById('ad-image-preview').innerHTML = 
                                `<img src="${downloadURL}" style="max-width:200px; max-height:150px; border-radius:5px; margin-top:10px;">`;
                            
                            document.getElementById('ad-upload-status').innerHTML = 
                                `<div class="upload-success">ä¸Šå‚³æˆåŠŸï¼åœ–ç‰‡å·²ä¿å­˜ã€‚</div>`;
                            
                            // æ›´æ–°å»£å‘Šé è¦½
                            this.updateAdPreview();
                        });
                    }
                );
            },
            
            // å»£å‘Šç®¡ç†åŠŸèƒ½
            toggleAdType: function() {
                const adType = document.querySelector('input[name="ad-type"]:checked').value;
                if(adType === 'image') {
                    document.getElementById('ad-image-input').style.display = 'block';
                    document.getElementById('ad-text-input').style.display = 'none';
                } else {
                    document.getElementById('ad-image-input').style.display = 'none';
                    document.getElementById('ad-text-input').style.display = 'block';
                }
                this.updateAdPreview();
            },
            
            updateAdPreview: function() {
                const adType = document.querySelector('input[name="ad-type"]:checked').value;
                const position = document.getElementById('ad-position').value;
                const preview = document.getElementById('ad-preview-content');
                let html = '';
                
                if(adType === 'image') {
                    if(this.uploadedImageUrl) {
                        html = `<img src="${this.uploadedImageUrl}" class="ad-image" alt="å»£å‘Šé è¦½" style="max-width:100%;">`;
                    } else {
                        html = '<div style="color:#999; padding:20px;">è«‹å…ˆä¸Šå‚³åœ–ç‰‡</div>';
                    }
                } else {
                    const text = document.getElementById('ad-text-content').value || 'å»£å‘Šæ–‡å­—é è¦½';
                    html = `<div class="ad-text">${text}</div>`;
                }
                
                const link = document.getElementById('ad-link').value;
                if(link) {
                    html = `<a href="${link}" target="_blank" style="display:block;">${html}</a>`;
                }
                
                // æ ¹æ“šä½ç½®æ·»åŠ æ¨£å¼
                let positionStyle = '';
                if(position === 'grade-selector') {
                    positionStyle = 'background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);';
                }
                
                preview.innerHTML = `<div style="${positionStyle} padding: 10px; border-radius: 8px;">${html}</div>`;
            },
            
            saveAd: function() {
                const position = document.getElementById('ad-position').value;
                const adType = document.querySelector('input[name="ad-type"]:checked').value;
                const link = document.getElementById('ad-link').value.trim();
                
                let adData = {
                    position: position,
                    type: adType,
                    link: link || null,
                    timestamp: Date.now()
                };
                
                if(adType === 'text') {
                    const text = document.getElementById('ad-text-content').value.trim();
                    if(!text) {
                        alert("è«‹è¼¸å…¥å»£å‘Šæ–‡å­—");
                        return;
                    }
                    adData.text = text;
                    
                    adsRef.push(adData).then(() => {
                        alert("å»£å‘Šä¿å­˜æˆåŠŸï¼");
                        this.loadAds();
                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById('ad-text-content').value = '';
                        document.getElementById('ad-link').value = '';
                        this.uploadedImageUrl = null;
                        document.getElementById('ad-image-preview').innerHTML = '';
                        document.getElementById('ad-upload-status').innerHTML = '';
                        this.updateAdPreview();
                    }).catch(error => {
                        alert("ä¿å­˜å¤±æ•—: " + error.message);
                    });
                } else {
                    if(!this.uploadedImageUrl) {
                        alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡");
                        return;
                    }
                    
                    adData.imageUrl = this.uploadedImageUrl;
                    
                    adsRef.push(adData).then(() => {
                        alert("å»£å‘Šä¿å­˜æˆåŠŸï¼");
                        this.loadAds();
                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById('ad-link').value = '';
                        this.uploadedImageUrl = null;
                        document.getElementById('ad-image-preview').innerHTML = '';
                        document.getElementById('ad-upload-status').innerHTML = '';
                        this.updateAdPreview();
                    }).catch(error => {
                        alert("ä¿å­˜å¤±æ•—: " + error.message);
                    });
                }
            },
            
            loadAds: function() {
                adsRef.orderByChild('timestamp').once('value').then(snap => {
                    const adList = document.getElementById('ad-list');
                    adList.innerHTML = '';
                    
                    if(!snap.exists()) {
                        adList.innerHTML = '<p>æš«ç„¡å»£å‘Š</p>';
                        return;
                    }
                    
                    const ads = [];
                    snap.forEach(child => {
                        ads.push({key: child.key, ...child.val()});
                    });
                    
                    // æŒ‰æ™‚é–“å€’åº
                    ads.reverse();
                    
                    ads.forEach(ad => {
                        const div = document.createElement('div');
                        div.style.cssText = 'border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px;';
                        
                        let content = '';
                        if(ad.type === 'image' && ad.imageUrl) {
                            content = `<img src="${ad.imageUrl}" style="max-width:200px; max-height:100px; display:block; margin-bottom:5px;">`;
                        } else if(ad.type === 'text' && ad.text) {
                            content = `<div style="font-weight:bold;">${ad.text}</div>`;
                        }
                        
                        if(ad.link) {
                            content = `<a href="${ad.link}" target="_blank">${content}</a>`;
                        }
                        
                        const positionNames = {
                            'login': 'ç™»å…¥é é¢ä¸‹æ–¹',
                            'grade-selector': 'å¹´ç´šé¸æ“‡ä¸Šæ–¹',
                            'rank': 'æ’åé é¢ä¸‹æ–¹'
                        };
                        
                        div.innerHTML = `
                            <div><strong>ä½ç½®:</strong> ${positionNames[ad.position] || ad.position}</div>
                            ${content}
                            <div style="margin-top:5px; font-size:0.8rem; color:#666;">
                                é¡å‹: ${ad.type} | å‰µå»ºæ™‚é–“: ${new Date(ad.timestamp).toLocaleString()}
                            </div>
                            <button class="btn-sm btn-del" style="margin-top:5px;" onclick="admin.deleteAd('${ad.key}')">åˆªé™¤</button>
                        `;
                        adList.appendChild(div);
                    });
                });
            },
            
            deleteAd: function(key) {
                if(confirm("ç¢ºå®šåˆªé™¤æ­¤å»£å‘Šï¼Ÿ")) {
                    adsRef.child(key).remove().then(() => {
                        this.loadAds();
                    });
                }
            },
            
            // å­¸ç”Ÿå›é¥‹ç®¡ç†åŠŸèƒ½
            loadFeedback: function() {
                const tbody = document.querySelector('#feedback-table tbody');
                tbody.innerHTML = '<tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>';
                
                dbRef.once('value').then(snap => {
                    tbody.innerHTML = '';
                    
                    if(!snap.exists()) {
                        tbody.innerHTML = '<tr><td colspan="7">æš«ç„¡æ•¸æ“š</td></tr>';
                        return;
                    }
                    
                    let records = [];
                    snap.forEach(child => {
                        const val = child.val();
                        records.push({key: child.key, ...val});
                    });
                    
                    // æŒ‰åˆ†æ•¸æ’å
                    const rankedRecords = calculateRanks(records);
                    
                    rankedRecords.slice(0, 50).forEach(r => { // åªé¡¯ç¤ºå‰50å
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="color:${r.rank===1?'gold':r.rank===2?'silver':r.rank===3?'#cd7f32':'#555'}">${r.rank}</td>
                            <td>${r.name}</td>
                            <td>${r.class}</td>
                            <td>${r.score}</td>
                            <td>
                                ${r.likes || 0} â¤ï¸
                                <button class="btn-sm" style="background:#ff6b6b; margin-left:5px; padding:2px 5px;" onclick="admin.toggleLike('${r.key}', ${r.likes || 0})">${r.likes > 0 ? 'å–æ¶ˆ' : 'é»è®š'}</button>
                            </td>
                            <td style="max-width:200px; word-break:break-word;">
                                ${r.teacherComment || ''}
                                <div style="margin-top:2px;">
                                    <button class="btn-sm btn-edit" style="padding:2px 5px; font-size:0.7rem;" onclick="admin.editComment('${r.key}', '${r.name}', '${r.class}')">ç·¨è¼¯</button>
                                    ${r.teacherComment ? '<button class="btn-sm btn-clear" style="padding:2px 5px; font-size:0.7rem; margin-left:2px;" onclick="admin.clearComment(\'' + r.key + '\')">æ¸…é™¤</button>' : ''}
                                </div>
                            </td>
                            <td>
                                <button class="btn-sm btn-del" onclick="admin.delRank('${r.key}')">X</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            },
            
            // é»è®šåŠŸèƒ½ï¼ˆåªæœ‰è€å¸«å¯ä»¥æ“ä½œï¼‰
            toggleLike: function(key, currentLikes) {
                const newLikes = currentLikes > 0 ? 0 : currentLikes + 1;
                dbRef.child(key).update({ likes: newLikes })
                    .then(() => {
                        this.loadFeedback();
                    });
            },
            
            // ç·¨è¼¯ç•™è¨€åŠŸèƒ½
            editComment: function(key, name, className) {
                dbRef.child(key).once('value').then(snap => {
                    const currentComment = snap.val().teacherComment || '';
                    const newComment = prompt(`ç·¨è¼¯çµ¦ ${name} (${className}) çš„ç•™è¨€ï¼š`, currentComment);
                    if(newComment !== null) {
                        dbRef.child(key).update({ teacherComment: newComment.trim() })
                            .then(() => {
                                this.loadFeedback();
                            });
                    }
                });
            },
            
            // æ¸…é™¤ç•™è¨€åŠŸèƒ½
            clearComment: function(key) {
                if(confirm("ç¢ºå®šæ¸…é™¤ç•™è¨€å—ï¼Ÿ")) {
                    dbRef.child(key).update({ teacherComment: "" })
                        .then(() => {
                            this.loadFeedback();
                        });
                }
            },
            
            searchStudent: function() {
                const searchTerm = document.getElementById('feedback-student-search').value.toLowerCase().trim();
                if(!searchTerm) return;
                
                const studentList = document.getElementById('student-feedback-list');
                studentList.innerHTML = '<div>æœå°‹ä¸­...</div>';
                
                dbRef.once('value').then(snap => {
                    studentList.innerHTML = '';
                    let found = false;
                    
                    let records = [];
                    snap.forEach(child => {
                        records.push({key: child.key, ...child.val()});
                    });
                    
                    // æŒ‰åˆ†æ•¸æ’å
                    const rankedRecords = calculateRanks(records);
                    
                    rankedRecords.forEach(r => {
                        if(r.name.toLowerCase().includes(searchTerm) || 
                           r.class.toLowerCase().includes(searchTerm)) {
                            found = true;
                            const div = document.createElement('div');
                            div.style.cssText = 'border-bottom:1px solid #eee; padding:10px 0;';
                            div.innerHTML = `
                                <div style="font-weight:bold;">${r.name} (${r.class}) - æ’å: ${r.rank} - åˆ†æ•¸: ${r.score}</div>
                                <div style="font-size:0.9rem; color:#666;">æ™‚é–“: ${r.date || ''} ${r.time || ''}</div>
                                <div style="margin-top:5px;">
                                    <span>â¤ï¸ ${r.likes || 0}</span>
                                    <span class="teacher-comment">${r.teacherComment || 'æš«ç„¡ç•™è¨€'}</span>
                                </div>
                                <div style="margin-top:5px;">
                                    <button class="btn-sm" style="background:#ff6b6b; padding:2px 5px;" onclick="admin.toggleLike('${r.key}', ${r.likes || 0})">${r.likes > 0 ? 'å–æ¶ˆé»è®š' : 'é»è®š'}</button>
                                    <button class="btn-sm btn-edit" style="padding:2px 5px; margin-left:5px;" onclick="admin.editComment('${r.key}', '${r.name}', '${r.class}')">ç·¨è¼¯ç•™è¨€</button>
                                    ${r.teacherComment ? '<button class="btn-sm btn-clear" style="padding:2px 5px; margin-left:5px;" onclick="admin.clearComment(\'' + r.key + '\')">æ¸…é™¤ç•™è¨€</button>' : ''}
                                </div>
                            `;
                            studentList.appendChild(div);
                        }
                    });
                    
                    if(!found) {
                        studentList.innerHTML = '<div>æœªæ‰¾åˆ°ç›¸é—œå­¸ç”Ÿ</div>';
                    }
                });
            },

            loadWords: function(grade) {
                this.currentWordGrade = grade;
                document.getElementById('admin-word-status').innerText = `Editing: ${grade}`;
                const tbody = document.querySelector('#admin-word-table tbody');
                tbody.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';
                
                wordsRef.child(grade).once('value', snap => {
                    tbody.innerHTML = "";
                    if(!snap.exists()) { tbody.innerHTML = "<tr><td colspan='2'>No words found</td></tr>"; return; }
                    
                    const val = snap.val();
                    let items = [];
                    if(Array.isArray(val)) {
                        val.forEach((w, i) => items.push({key: i, val: w}));
                    } else {
                        Object.keys(val).forEach(k => items.push({key: k, val: val[k]}));
                    }

                    items.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td style="text-align:left;">${item.val}</td><td><button class="btn-sm btn-del" onclick="admin.delWord('${item.key}')">X</button></td>`;
                        tbody.appendChild(tr);
                    });
                });
            },
            addWord: function() {
                const w = document.getElementById('new-word-input').value.trim();
                if(w) {
                    wordsRef.child(this.currentWordGrade).push(w).then(() => {
                        document.getElementById('new-word-input').value = "";
                        this.loadWords(this.currentWordGrade);
                    });
                }
            },
            delWord: function(key) {
                if(confirm("Delete this word?")) {
                    wordsRef.child(this.currentWordGrade).child(key).remove().then(() => this.loadWords(this.currentWordGrade));
                }
            }
        };

        window.onload = () => game.init();
    </script>
</body>
</html>
