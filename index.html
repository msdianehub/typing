<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ ¡åœ’è‹±èªæ‰“å­—ç·´ç¿’ (é›²ç«¯æ’è¡Œç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary: #4ecdc4;
            --secondary: #ff6b6b;
            --dark: #1a535c;
            --light: #f7fff7;
            --accent: #ffd166;
            --p1-color: #ff9f43;
            --p2-color: #54a0ff;
            --p3-color: #5f27cd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Verdana', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow-x: hidden;
            overscroll-behavior: none;
        }
        
        .container {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 900px;
            padding: 20px;
            text-align: center;
            border: 4px solid #fff;
            position: relative;
        }

        h1 {
            color: var(--dark);
            margin-bottom: 10px;
            text-shadow: 1px 1px 0 var(--accent);
            font-size: 1.8rem;
        }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        .info-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #f1f2f6;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .player-info {
            font-size: 1rem;
            color: var(--dark);
            font-weight: bold;
        }

        .game-stats {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .stat-item {
            background: white;
            padding: 5px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 100px;
        }

        /* --- å¹´ç´šèˆ‡é›£åº¦æŒ‰éˆ• --- */
        .grade-selector {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .grade-btn {
            padding: 8px 16px;
            font-size: 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .grade-btn.p1 { background-color: var(--p1-color); }
        .grade-btn.p2 { background-color: var(--p2-color); }
        .grade-btn.p3 { background-color: var(--p3-color); }

        .grade-btn.active {
            opacity: 1;
            transform: scale(1.05);
            outline: 2px solid var(--dark);
            box-shadow: 0 3px 0 rgba(0,0,0,0.2);
        }

        .level-selector { 
            margin: 5px 0 15px 0; 
            min-height: 35px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .level-btn {
            background: #eee;
            border: 2px solid #ccc;
            padding: 6px 14px;
            border-radius: 15px;
            font-weight: bold;
            color: #777;
            font-size: 0.9rem;
        }
        .level-btn.active {
            background: var(--dark);
            color: white;
            border-color: var(--dark);
        }

        /* --- é¡Œç›®é¡¯ç¤ºå€ --- */
        .target-box {
            background-color: #fff;
            border: 3px dashed var(--dark);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            font-size: 2rem;
            font-family: 'Courier New', monospace;
            word-break: break-word;
        }

        .char { margin: 0 1px; border-radius: 2px; }
        .char-space { margin: 0 4px; border-bottom: 2px solid #ddd; width: 15px; display: inline-block; }
        .correct { color: var(--primary); }
        .error-anim { animation: shake 0.3s; color: var(--secondary); }
        .pending { color: #ccc; }

        /* --- è¼¸å…¥æ¡† --- */
        #game-input {
            width: 100%;
            padding: 10px;
            font-size: 1.5rem;
            text-align: center;
            border: 3px solid #ccc;
            border-radius: 10px;
            outline: none;
            background-color: #f9f9f9;
            -webkit-user-select: text;
            user-select: text;
        }
        #game-input:focus { border-color: var(--primary); background-color: #fff; }

        /* --- æ§åˆ¶å€ --- */
        .controls { 
            margin-top: 15px; 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px; 
            font-size: 1rem; 
            border: none; 
            border-radius: 10px;
            cursor: pointer; 
            color: white; 
            font-weight: bold; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            touch-action: manipulation;
        }
        .btn:active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        .btn-start { background-color: var(--primary); width: 100%; max-width: 200px; }
        .btn-reset { background-color: var(--secondary); }
        .btn-rank { background-color: var(--dark); }

        .progress-wrap { width: 100%; height: 10px; background: #eee; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; width: 100%; background: var(--secondary); transition: width 1s linear; }

        /* --- é®ç½©èˆ‡å½ˆçª— --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(3px);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
            padding: 20px;
        }
        .hidden { display: none !important; }

        .modal-box {
            background: white; padding: 25px; border-radius: 20px;
            width: 100%; max-width: 500px; text-align: center;
            border: 4px solid var(--accent);
            animation: popIn 0.3s;
            position: relative;
        }

        /* è®€å–ä¸­å‹•ç•« */
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ç™»å…¥æ¨£å¼ */
        .login-input { 
            width: 100%; padding: 12px; margin: 8px 0; 
            border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; 
            -webkit-user-select: text; user-select: text;
        }
        .login-label { display: block; text-align: left; font-weight: bold; color: var(--dark); margin-top: 5px;}

        /* æ’è¡Œæ¦œè¡¨æ ¼ */
        .rank-tabs { margin-bottom: 10px; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;}
        .rank-tab-btn { padding: 6px 12px; border: none; border-radius: 15px; cursor: pointer; background: #eee; color: #666; font-weight: bold; font-size: 0.9rem;}
        .rank-tab-btn.active { background: var(--dark); color: white; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #eee; padding: 8px; color: #555; white-space: nowrap;}
        td { padding: 8px 4px; border-bottom: 1px solid #eee; word-break: break-all;}
        
        @media (max-width: 480px) {
            h1 { font-size: 1.5rem; }
            .info-header { flex-direction: row; flex-wrap: wrap; justify-content: center; }
            .target-box { font-size: 1.8rem; padding: 10px; }
            .btn { flex: 1; }
            .btn-start { flex: 0 0 100%; margin-bottom: 5px; }
            table { font-size: 0.8rem; }
            th:nth-child(5), td:nth-child(5) { display: none; }
        }

        @media (min-width: 768px) {
            .container { padding: 40px; }
            .target-box { font-size: 3rem; min-height: 150px; }
            .info-header { flex-direction: row; justify-content: space-between; }
            #game-input { font-size: 2rem; }
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div class="modal-overlay" id="login-overlay">
        <div class="modal-box">
            <h2 style="color: var(--secondary); margin-bottom: 15px;">ğŸ‘‹ æ­¡è¿ä¾†åˆ°æ‰“å­—ç·´ç¿’</h2>
            <p style="color: #666; margin-bottom: 15px;">è«‹å…ˆè¼¸å…¥è³‡æ–™</p>
            
            <label class="login-label">ç­åˆ¥ (Class):</label>
            <input type="text" class="login-input" id="login-class" placeholder="ä¾‹å¦‚: 1A" autocomplete="off" autocorrect="off">
            
            <label class="login-label">å§“å (Name):</label>
            <input type="text" class="login-input" id="login-name" placeholder="ä¾‹å¦‚: é™³å°æ˜" autocomplete="off" autocorrect="off">
            
            <button class="btn btn-start" id="login-btn" style="margin-top: 15px;">é€²å…¥ç·´ç¿’ (Enter)</button>
        </div>
    </div>

    <div class="container">
        <h1>ğŸ« æ ¡åœ’è‹±èªæ‰“å­—ç·´ç¿’</h1>
        
        <div class="info-header">
            <div class="player-info">
                å­¸ç”Ÿ: <span id="display-name" style="color: var(--secondary);">---</span> 
                (<span id="display-class" style="color: var(--dark);">---</span>)
            </div>
            <div class="game-stats">
                <div class="stat-item" style="color: var(--primary);">å¾—åˆ†: <span id="score">0</span></div>
                <div class="stat-item" style="color: var(--secondary);">æ™‚é–“: <span id="timer">60</span>s</div>
            </div>
        </div>

        <h3 style="margin-bottom: 8px; color: #777; font-size: 1rem;">é¸æ“‡å¹´ç´š (Grade)</h3>
        <div class="grade-selector">
            <button class="grade-btn p1 active" onclick="game.setGrade('P1')">P1 ä¸€å¹´ç´š</button>
            <button class="grade-btn p2" onclick="game.setGrade('P2')">P2 äºŒå¹´ç´š</button>
            <button class="grade-btn p3" onclick="game.setGrade('P3')">P3 ä¸‰å¹´ç´š</button>
        </div>

        <div class="level-selector" id="level-container">
            <span style="color: #999; font-size: 0.9rem;">(æœ¬å¹´ç´šåªæœ‰ä¸€å€‹é›£åº¦)</span>
        </div>

        <div class="target-box" id="target-display">
            æº–å‚™å¥½äº†å—ï¼Ÿ
        </div>
        
        <div class="progress-wrap">
            <div class="progress-fill" id="time-bar"></div>
        </div>

        <div style="margin-top: 15px;">
            <input type="text" id="game-input" 
                   placeholder="é»æ“Šé–‹å§‹å¾Œè¼¸å…¥..." 
                   autocomplete="off" 
                   autocorrect="off" 
                   autocapitalize="off" 
                   spellcheck="false"
                   enterkeyhint="done"
                   disabled>
        </div>

        <div class="controls">
            <button class="btn btn-start" id="start-btn">é–‹å§‹éŠæˆ² (Start)</button>
            <button class="btn btn-reset" id="reset-btn" disabled>é‡ç½® (Reset)</button>
            <button class="btn btn-rank" id="rank-btn">ğŸ† é›²ç«¯æ’è¡Œæ¦œ</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="rank-overlay">
        <div class="modal-box">
            <h2 style="color: var(--dark); margin-bottom: 10px;">ğŸ† é›²ç«¯æ’è¡Œæ¦œ</h2>
            
            <div class="rank-tabs">
                <button class="rank-tab-btn" id="rank-tab-p1" onclick="game.showRank('P1')">P1æ¦œ</button>
                <button class="rank-tab-btn" id="rank-tab-p2" onclick="game.showRank('P2')">P2æ¦œ</button>
                <button class="rank-tab-btn" id="rank-tab-p3" onclick="game.showRank('P3')">P3æ¦œ</button>
            </div>

            <div id="rank-loading" class="hidden"><div class="loading-spinner"></div></div>
            
            <div style="max-height: 250px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                <table id="rank-table">
                    <thead>
                        <tr>
                            <th width="10%">#</th>
                            <th width="15%">ç­åˆ¥</th>
                            <th width="20%">å§“å</th>
                            <th width="15%">åˆ†</th>
                            <th width="20%">æ—¥æœŸ</th>
                            <th width="20%">æ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="btn btn-start" style="margin-top: 15px;" onclick="game.closeRank()">é—œé–‰ (Close)</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="result-overlay">
        <div class="modal-box">
            <h2>â° æ™‚é–“åˆ°ï¼</h2>
            <div style="font-size: 3.5rem; color: var(--secondary); font-weight: bold; margin: 10px 0;" id="final-score">0</div>
            <p id="final-msg" style="margin-bottom: 20px; color: #555; font-size: 1.2rem; font-weight: bold;"></p>
            <button class="btn btn-start" onclick="game.closeResult()">æŸ¥çœ‹æ’å</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”¥ é‡è¦ï¼šè«‹åœ¨é€™è£¡æ›¿æ›æ‚¨çš„ Firebase è¨­å®š ğŸ”¥
        // ==========================================
        const firebaseConfig = {
            apiKey: "è«‹è²¼ä¸Šæ‚¨çš„APIKey",
            authDomain: "è«‹è²¼ä¸Šæ‚¨çš„AuthDomain",
            projectId: "è«‹è²¼ä¸Šæ‚¨çš„ProjectId",
            storageBucket: "è«‹è²¼ä¸Šæ‚¨çš„StorageBucket",
            messagingSenderId: "è«‹è²¼ä¸Šæ‚¨çš„ID",
            appId: "è«‹è²¼ä¸Šæ‚¨çš„AppID"
        };

        // åˆå§‹åŒ– Firebase
        let db; // è³‡æ–™åº«ç‰©ä»¶
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log("Firebase Connected");
        } catch (error) {
            console.error("Firebase Init Error:", error);
            alert("è³‡æ–™åº«é€£ç·šè¨­å®šæœ‰èª¤ï¼Œè«‹æª¢æŸ¥ HTML ä»£ç¢¼ä¸­çš„ firebaseConfig");
        }

        /**
         * éŸ³æ•ˆç³»çµ±
         */
        const sfx = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            play: function(freqs, type='sine', dur=0.1) {
                if (!this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freqs, this.ctx.currentTime);
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + dur);
                } catch(e) {}
            },
            correct: function() { this.init(); this.play(800); },
            error: function() { this.init(); this.play(150, 'sawtooth', 0.2); },
            success: function() {
                this.init();
                [523, 659, 784].forEach((f, i) => setTimeout(() => this.play(f, 'sine', 0.2), i*100));
            }
        };

        /**
         * éŠæˆ²ä¸»ç¨‹å¼
         */
        const game = {
            data: {
                "P1": {
                    levels: { 1: ["a ball", "a car", "a doll", "a robot", "a bus", "a teddy bear", "red", "blue", "white", "pink"] },
                    hasSubLevels: false
                },
                "P2": {
                    levels: { 1: ["kind", "friendly", "helpful", "clever", "funny", "polite", "in front of", "behind", "between", "because"] },
                    hasSubLevels: false
                },
                "P3": {
                    levels: {
                        1: ["classroom", "art room", "computer room", "music room", "library", "school hall", "lift", "toilets"],
                        2: ["on the left", "on the right", "next to", "Where's", "Where are"],
                        3: ["ground floor", "first floor", "second floor", "third floor", "fourth floor", "fifth floor", "sixth floor"]
                    },
                    hasSubLevels: true
                }
            },

            state: {
                player: { name: "", class: "" },
                currentGrade: "P1",
                currentLevel: 1,
                score: 0,
                timeLeft: 60,
                isPlaying: false,
                currentWord: "",
                timerId: null
            },

            el: {
                loginOverlay: document.getElementById('login-overlay'),
                displayName: document.getElementById('display-name'),
                displayClass: document.getElementById('display-class'),
                levelContainer: document.getElementById('level-container'),
                target: document.getElementById('target-display'),
                input: document.getElementById('game-input'),
                score: document.getElementById('score'),
                timer: document.getElementById('timer'),
                timeBar: document.getElementById('time-bar'),
                rankTableBody: document.querySelector('#rank-table tbody'),
                rankLoading: document.getElementById('rank-loading')
            },

            init: function() {
                this.bindClick('login-btn', () => this.handleLogin());
                this.bindClick('start-btn', () => this.startGame());
                this.bindClick('reset-btn', () => this.resetGame());
                this.bindClick('rank-btn', () => this.showRank(this.state.currentGrade));
                
                this.el.input.addEventListener('input', (e) => this.handleInput(e));
                this.setGrade('P1');
            },

            bindClick: function(id, handler) {
                const el = document.getElementById(id);
                if(el) el.addEventListener('click', (e) => {
                    e.preventDefault();
                    handler();
                });
            },

            handleLogin: function() {
                const c = document.getElementById('login-class').value.trim();
                const n = document.getElementById('login-name').value.trim();
                if(!c || !n) return alert("è«‹è¼¸å…¥ç­åˆ¥å’Œå§“åï¼");
                
                sfx.init();
                sfx.correct();
                
                this.state.player = { class: c, name: n };
                this.el.displayClass.textContent = c;
                this.el.displayName.textContent = n;
                this.el.loginOverlay.classList.add('hidden');
            },

            setGrade: function(grade) {
                if(this.state.isPlaying) return;
                this.state.currentGrade = grade;
                this.state.currentLevel = 1;
                
                document.querySelectorAll('.grade-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if(btn.classList.contains(grade.toLowerCase())) btn.classList.add('active');
                });

                this.renderLevelSelector(grade);
                this.el.target.textContent = `${grade} æº–å‚™å®Œæˆ`;
            },

            renderLevelSelector: function(grade) {
                const config = this.data[grade];
                this.el.levelContainer.innerHTML = '';

                if (config.hasSubLevels) {
                    [1, 2, 3].forEach(lvl => {
                        const btn = document.createElement('button');
                        btn.className = `level-btn ${lvl === 1 ? 'active' : ''}`;
                        btn.textContent = `Level ${lvl}`;
                        btn.onclick = (e) => {
                            e.preventDefault();
                            if(this.state.isPlaying) return;
                            this.state.currentLevel = lvl;
                            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                        };
                        this.el.levelContainer.appendChild(btn);
                    });
                } else {
                    this.el.levelContainer.innerHTML = '<span style="color:#888; font-weight:bold;">(ç¶œåˆç·´ç¿’)</span>';
                }
            },

            startGame: function() {
                if(this.state.isPlaying) return;
                
                sfx.init();
                this.state.isPlaying = true;
                this.state.score = 0;
                this.state.timeLeft = 60;
                
                this.el.score.textContent = 0;
                this.el.timer.textContent = 60;
                this.el.timeBar.style.width = "100%";
                this.el.input.disabled = false;
                this.el.input.value = "";
                this.el.input.focus();
                
                document.getElementById('start-btn').disabled = true;
                document.getElementById('reset-btn').disabled = false;
                document.querySelectorAll('.grade-btn').forEach(b => b.disabled = true);
                
                this.nextWord();
                
                this.state.timerId = setInterval(() => {
                    this.state.timeLeft--;
                    this.el.timer.textContent = this.state.timeLeft;
                    this.el.timeBar.style.width = (this.state.timeLeft / 60 * 100) + "%";
                    if(this.state.timeLeft <= 0) this.endGame();
                }, 1000);
            },

            resetGame: function() {
                clearInterval(this.state.timerId);
                this.state.isPlaying = false;
                this.el.input.disabled = true;
                this.el.input.value = "";
                this.el.target.textContent = "è«‹é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€";
                document.getElementById('start-btn').disabled = false;
                document.getElementById('reset-btn').disabled = true;
                document.querySelectorAll('.grade-btn').forEach(b => b.disabled = false);
                this.el.score.textContent = 0;
                this.el.timer.textContent = 60;
                this.el.timeBar.style.width = "100%";
            },

            nextWord: function() {
                const gradeData = this.data[this.state.currentGrade];
                const wordList = gradeData.levels[this.state.currentLevel];
                this.state.currentWord = wordList[Math.floor(Math.random() * wordList.length)];
                this.renderWord("");
            },

            renderWord: function(inputVal) {
                let html = "";
                const word = this.state.currentWord;
                for(let i=0; i<word.length; i++) {
                    let cls = "char pending";
                    if(i < inputVal.length) {
                        cls = inputVal[i] === word[i] ? "char correct" : "char error-anim";
                    }
                    if(word[i] === " ") html += `<span class="${cls} char-space">&nbsp;</span>`;
                    else html += `<span class="${cls}">${word[i]}</span>`;
                }
                this.el.target.innerHTML = html;
            },

            handleInput: function(e) {
                if(!this.state.isPlaying) return;
                const val = this.el.input.value;
                const target = this.state.currentWord;
                
                if(e.inputType && e.inputType.includes('delete')) return this.renderWord(val);
                
                const idx = val.length - 1;
                if(val.length === 0) { this.renderWord(""); return; }

                if(val.length > 0) {
                    if(idx >= target.length) {
                        this.el.input.value = val.slice(0, -1);
                        sfx.error();
                        return;
                    }
                    
                    if(val[idx] !== target[idx]) {
                        sfx.error();
                        this.el.input.value = val.slice(0, -1);
                        this.el.target.classList.add('error-anim');
                        setTimeout(() => this.el.target.classList.remove('error-anim'), 300);
                    } else {
                        sfx.correct();
                        this.renderWord(val);
                        if(val === target) {
                            const basePoints = 10;
                            const bonus = this.state.currentGrade === 'P3' ? this.state.currentLevel * 5 : 0;
                            this.state.score += (basePoints + bonus);
                            this.el.score.textContent = this.state.score;
                            sfx.success();
                            setTimeout(() => {
                                this.el.input.value = "";
                                this.nextWord();
                            }, 200);
                        }
                    }
                }
            },

            endGame: function() {
                clearInterval(this.state.timerId);
                this.state.isPlaying = false;
                this.el.input.disabled = true;
                
                this.saveScoreToCloud(); // å„²å­˜åˆ°é›²ç«¯
                
                document.getElementById('final-score').textContent = this.state.score;
                document.getElementById('final-msg').textContent = `${this.state.player.name} | è¡¨ç¾ä¸éŒ¯å–”ï¼`;
                document.getElementById('result-overlay').classList.remove('hidden');
            },

            // --- Firestore æ•´åˆ ---
            
            saveScoreToCloud: function() {
                if(!db) return; // å¦‚æœæ²’é€£ç·šå°±ä¸å­˜
                
                const now = new Date();
                const dateStr = `${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}`;
                const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                
                // å„²å­˜åˆ° 'scores' é›†åˆ
                db.collection("scores").add({
                    grade: this.state.currentGrade,
                    name: this.state.player.name,
                    class: this.state.player.class,
                    score: this.state.score,
                    date: dateStr,
                    time: timeStr,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    console.log("Score saved!");
                }).catch((error) => {
                    console.error("Error saving score: ", error);
                });
            },

            showRank: function(grade) {
                document.querySelectorAll('.rank-tab-btn').forEach(b => b.classList.remove('active'));
                const tabId = `rank-tab-${grade.toLowerCase()}`;
                const tabBtn = document.getElementById(tabId);
                if(tabBtn) tabBtn.classList.add('active');

                this.el.rankTableBody.innerHTML = "";
                this.el.rankLoading.classList.remove('hidden');
                document.getElementById('rank-overlay').classList.remove('hidden');

                if(!db) {
                    this.el.rankLoading.classList.add('hidden');
                    this.el.rankTableBody.innerHTML = `<tr><td colspan="6">è³‡æ–™åº«æœªé€£æ¥</td></tr>`;
                    return;
                }

                // æŸ¥è©¢é›²ç«¯è³‡æ–™ï¼šç¯©é¸å¹´ç´š
                db.collection("scores")
                    .where("grade", "==", grade)
                    // æ³¨æ„ï¼šFirestore å¦‚æœè¦åŒæ™‚ filter å’Œ sortï¼Œéœ€è¦å»ºç«‹ç´¢å¼•ã€‚
                    // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å…ˆæŠ“å–è³‡æ–™ï¼Œç„¶å¾Œåœ¨ JS ç«¯æ’åº
                    .limit(100) 
                    .get()
                    .then((querySnapshot) => {
                        let records = [];
                        querySnapshot.forEach((doc) => {
                            records.push(doc.data());
                        });

                        // åœ¨å‰ç«¯æ’åº (åˆ†æ•¸é«˜->ä½)
                        records.sort((a, b) => b.score - a.score);
                        
                        // åªå–å‰ 50 å
                        records = records.slice(0, 50);

                        this.el.rankLoading.classList.add('hidden');
                        
                        if (records.length === 0) {
                            this.el.rankTableBody.innerHTML = `<tr><td colspan="6" style="padding:20px;">${grade} æš«ç„¡ç´€éŒ„</td></tr>`;
                            return;
                        }

                        records.forEach((r, i) => {
                            let rankDisplay = i + 1;
                            let color = "#555";
                            if(i===0) { rankDisplay = "ğŸ¥‡"; color="gold"; }
                            if(i===1) { rankDisplay = "ğŸ¥ˆ"; color="silver"; }
                            if(i===2) { rankDisplay = "ğŸ¥‰"; color="#cd7f32"; }

                            const tr = `<tr>
                                <td style="color:${color}; font-weight:bold;">${rankDisplay}</td>
                                <td>${r.class}</td>
                                <td>${r.name}</td>
                                <td style="color:var(--primary); font-weight:bold;">${r.score}</td>
                                <td>${r.date}</td>
                                <td>${r.time}</td>
                            </tr>`;
                            this.el.rankTableBody.innerHTML += tr;
                        });
                    })
                    .catch((error) => {
                        console.error("Error getting documents: ", error);
                        this.el.rankLoading.classList.add('hidden');
                        this.el.rankTableBody.innerHTML = `<tr><td colspan="6">è®€å–å¤±æ•—</td></tr>`;
                    });
            },

            closeRank: function() {
                document.getElementById('rank-overlay').classList.add('hidden');
            },

            closeResult: function() {
                document.getElementById('result-overlay').classList.add('hidden');
                this.showRank(this.state.currentGrade);
                this.resetGame();
            }
        };

        window.onload = () => game.init();
    </script>
</body>
</html>
