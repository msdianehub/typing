<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title> ESLCLGGËã±Ë™ûÊâìÂ≠óÁ∑¥Áøí </title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #4ecdc4; --secondary: #ff6b6b; --dark: #1a535c; --accent: #ffd166; --p1-color: #ff9f43; --p2-color: #54a0ff; --p3-color: #5f27cd; --chal-color: #2c3e50; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Comic Sans MS', sans-serif; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-x: hidden; overscroll-behavior: none;}
        .container { background-color: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 100%; max-width: 900px; padding: 20px; text-align: center; border: 4px solid #fff; position: relative; }
        h1 { color: var(--dark); margin-bottom: 10px; font-size: 1.8rem; }
        .info-header { display: flex; flex-direction: column; gap: 10px; background-color: #f1f2f6; padding: 10px; border-radius: 12px; margin-bottom: 15px; }
        .player-info { font-size: 1rem; color: var(--dark); font-weight: bold; }
        .game-stats { display: flex; justify-content: center; gap: 10px; font-size: 1.1rem; font-weight: bold; }
        
        .grade-selector { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .grade-btn { padding: 8px 16px; font-size: 1rem; border: none; border-radius: 20px; cursor: pointer; color: white; opacity: 0.6; transition: 0.2s; }
        .grade-btn.p1 { background: var(--p1-color); } 
        .grade-btn.p2 { background: var(--p2-color); } 
        .grade-btn.p3 { background: var(--p3-color); }
        .grade-btn.challenge { background: var(--chal-color); font-weight: bold; border: 2px solid gold; }
        .grade-btn.active { opacity: 1; transform: scale(1.05); outline: 2px solid var(--dark); }
        
        .target-box { background: #fff; border: 3px dashed var(--dark); border-radius: 12px; padding: 15px; margin: 10px 0; min-height: 100px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; font-size: 2rem; font-family: 'Courier New', monospace; word-break: break-word; }
        .char { margin: 0 1px; } 
        .correct { color: var(--primary); } .error-anim { color: var(--secondary); animation: shake 0.3s; } .pending { color: #ccc; }
        
        /* P1 Spelling Styles */
        .scramble-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 15px; min-height: 60px; }
        .scramble-btn { background: #fff; border: 2px solid var(--p1-color); color: var(--dark); font-size: 1.5rem; width: 45px; height: 45px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #ddd; transition: transform 0.1s; }
        .scramble-btn:active { transform: translateY(4px); box-shadow: none; }
        .scramble-btn.used { opacity: 0.3; pointer-events: none; border-color: #ccc; transform: translateY(4px); box-shadow: none; }
        .p1-slot { display: inline-block; width: 30px; height: 40px; border-bottom: 3px solid #ccc; margin: 0 4px; text-align: center; color: var(--dark); }
        .p1-slot.filled { border-color: var(--p1-color); }
        .p1-slot.hint { color: #999; border-color: #eee; }

        #game-input { width: 100%; padding: 10px; font-size: 1.5rem; text-align: center; border: 3px solid #ccc; border-radius: 10px; outline: none; background: #f9f9f9; -webkit-user-select: text; user-select: text; }
        #game-input:focus { border-color: var(--primary); background: #fff; }
        
        .controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; font-size: 1rem; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; }
        .btn-start { background: var(--primary); width: 100%; max-width: 200px; } .btn-reset { background: var(--secondary); } .btn-rank { background: var(--dark); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
        .hidden { display: none !important; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 500px; text-align: center; border: 4px solid var(--accent); position: relative; max-height: 90vh; overflow-y: auto;}
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; -webkit-user-select: text; user-select: text; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; } th { background: #eee; padding: 8px; white-space: nowrap;} td { padding: 8px 4px; border-bottom: 1px solid #eee; }
        
        /* MsDiane Admin Styles */
        .admin-trigger { position: fixed; bottom: 10px; right: 10px; width: 30px; height: 30px; background: rgba(0,0,0,0.1); border-radius: 50%; cursor: pointer; z-index: 9000; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #555; }
        .admin-trigger:hover { background: rgba(0,0,0,0.3); }
        
        .admin-nav { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .admin-tab-btn { flex: 1; padding: 10px; cursor: pointer; background: #f9f9f9; border: none; font-weight: bold; color: #777; }
        .admin-tab-btn.active { background: white; color: var(--dark); border-bottom: 3px solid var(--dark); }
        
        .admin-panel-content { display: none; text-align: left; }
        .admin-panel-content.active { display: block; }
        
        .admin-filter-bar { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; cursor: pointer; border: none; color: white; }
        .btn-del { background: #ff6b6b; } .btn-add { background: #4ecdc4; }
        
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div class="admin-trigger" onclick="admin.openLogin()">MsD</div>

    <div class="modal-overlay" id="login-overlay">
        <div class="modal-box">
            <h2 style="color: var(--secondary); margin-bottom: 15px;">üëã Welcome to my hub</h2>
            <input type="text" class="login-input" id="login-class" placeholder="Class: 1A" autocorrect="off">
            <input type="text" class="login-input" id="login-name" placeholder="Name: Diane" autocorrect="off">
            <button class="btn btn-start" id="login-btn" style="margin-top: 15px;">Start</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="admin-login-overlay">
        <div class="modal-box" style="max-width: 300px;">
            <h3>üîë MsDiane Only</h3>
            <input type="password" class="login-input" id="admin-pass" placeholder="Password">
            <button class="btn btn-start" onclick="admin.login()">Login</button>
            <button class="btn" onclick="document.getElementById('admin-login-overlay').classList.add('hidden')" style="background:#ccc; margin-top:5px;">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="admin-dash-overlay">
        <div class="modal-box" style="max-width: 800px; padding: 0; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;">
            
            <div style="padding: 15px; background: var(--dark); color: white; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; font-size:1.2rem; color:white;">üõ†Ô∏è Admin Panel</h2>
                <button class="btn-sm" style="background:#444;" onclick="admin.close()">Exit</button>
            </div>

            <div class="admin-nav">
                <button class="admin-tab-btn active" onclick="admin.switchTab('rank')">üìä ÊàêÁ∏æÁÆ°ÁêÜ (Rankings)</button>
                <button class="admin-tab-btn" onclick="admin.switchTab('word')">üìù Â≠óÂ∫´ÁÆ°ÁêÜ (Words)</button>
            </div>

            <div style="padding: 15px; overflow-y: auto; flex: 1;">
                
                <div id="admin-tab-rank" class="admin-panel-content active">
                    <div class="admin-filter-bar">
                        <button class="grade-btn p1" onclick="admin.loadRanks('P1')">P1</button>
                        <button class="grade-btn p2" onclick="admin.loadRanks('P2')">P2</button>
                        <button class="grade-btn p3" onclick="admin.loadRanks('P3')">P3</button>
                        <button class="grade-btn challenge" onclick="admin.loadRanks('Challenge')">Chall.</button>
                        <button class="grade-btn" style="background:#333; color:white;" onclick="admin.loadRanks('ALL')">ALL</button>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span id="admin-rank-status" style="font-weight:bold; color:#666;">Select a grade</span>
                        <button class="btn-sm btn-del" onclick="admin.clearAllRanks()">‚ö†Ô∏è Ê∏ÖÈô§Ê≠§ÁµÑÊâÄÊúâÁ¥ÄÈåÑ (Clear All)</button>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee;">
                        <table id="admin-rank-table">
                            <thead><tr><th>G</th><th>Cls</th><th>Name</th><th>Score</th><th>Date/Time</th><th>Act</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-tab-word" class="admin-panel-content">
                    <div class="admin-filter-bar">
                        <button class="grade-btn p1" onclick="admin.loadWords('P1')">P1 Words</button>
                        <button class="grade-btn p2" onclick="admin.loadWords('P2')">P2 Words</button>
                        <button class="grade-btn p3" onclick="admin.loadWords('P3')">P3 Words</button>
                        <button class="grade-btn challenge" onclick="admin.loadWords('Challenge')">Chall. Words</button>
                    </div>

                    <div style="background:#f0f0f0; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <span id="admin-word-status" style="font-weight:bold; color:var(--dark); display:block; margin-bottom:5px;">Select grade to edit</span>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="new-word-input" class="login-input" placeholder="New word/sentence..." style="margin:0; font-size:0.9rem;">
                            <button class="btn-sm btn-add" onclick="admin.addWord()">Add</button>
                        </div>
                    </div>

                    <div style="max-height: 350px; overflow-y: auto; border: 1px solid #eee;">
                        <table id="admin-word-table">
                            <thead><tr><th>Word / Sentence</th><th>Act</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="container">
        <h1>üè´ ESLCLGG</h1>
        <div class="info-header">
            <div class="player-info">Â≠∏Áîü: <span id="display-name">---</span> (<span id="display-class">---</span>)</div>
            <div class="game-stats">
                <div style="background:white;padding:5px 10px;border-radius:8px;">ÂæóÂàÜ Score: <span id="score">0</span></div>
                <div style="background:white;padding:5px 10px;border-radius:8px;">ÊôÇÈñì Time: <span id="timer">60</span>s</div>
            </div>
        </div>
        <div class="grade-selector">
            <button class="grade-btn p1 active" onclick="game.setGrade('P1')">P1 ‰∏ÄÂπ¥Á¥ö</button>
            <button class="grade-btn p2" onclick="game.setGrade('P2')">P2 ‰∫åÂπ¥Á¥ö</button>
            <button class="grade-btn p3" onclick="game.setGrade('P3')">P3 ‰∏âÂπ¥Á¥ö</button>
            <button class="grade-btn challenge" onclick="game.setGrade('Challenge')">{Challenge MsDiane}</button>
        </div>
        
        <div class="target-box" id="target-display">Ê∫ñÂÇôÂ•Ω‰∫ÜÂóéÔºü</div>
        
        <div id="p1-interface" class="hidden">
            <div class="scramble-container" id="scramble-box"></div>
        </div>

        <div id="typing-interface" style="margin-top: 15px;">
            <input type="text" id="game-input" placeholder="Type here..." disabled autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>

        <div class="controls">
            <button class="btn btn-start" id="start-btn">ÈñãÂßãÈÅäÊà≤ Start</button>
            <button class="btn btn-reset" id="reset-btn" disabled>ÈáçÁΩÆ Reset</button>
            <button class="btn btn-rank" id="rank-btn">üèÜ ÊéíË°åÊ¶ú Leaderboard</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="rank-overlay">
        <div class="modal-box">
            <h2>üèÜ ÊéíË°åÊ¶ú Leaderboard</h2>
            <div style="margin-bottom:10px; display:flex; justify-content:center; gap:5px; flex-wrap:wrap;" id="rank-tabs">
                <button class="grade-btn p1" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P1')">P1</button>
                <button class="grade-btn p2" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P2')">P2</button>
                <button class="grade-btn p3" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P3')">P3</button>
                <button class="grade-btn challenge" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('Challenge')">Chall.</button>
            </div>
            
            <div id="rank-loading" class="hidden"><div class="spinner"></div></div>
            <div id="rank-msg" style="color:#666; font-size:0.9rem; margin:10px 0;"></div>
            
            <div style="max-height: 250px; overflow-y: auto;">
                <table id="rank-table"><thead><tr><th>#</th><th>Class</th><th>Name</th><th>Score</th></tr></thead><tbody></tbody></table>
            </div>
            <button class="btn btn-start" style="margin-top: 15px;" onclick="document.getElementById('rank-overlay').classList.add('hidden')">ÈóúÈñâ</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="result-overlay">
        <div class="modal-box">
            <h2>‚è∞ ÊôÇÈñìÂà∞ÔºÅTime's up</h2>
            <div style="font-size: 3.5rem; color: var(--secondary); margin: 10px 0;" id="final-score">0</div>
            <p id="final-msg" style="margin-bottom: 20px; font-weight:bold;"></p>
            <button class="btn btn-start" onclick="game.closeResult()">Êü•ÁúãÊéíÂêç</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚úÖ Firebase SDK Init
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDU6GWmH-rgvqWvGC45hhqXE_p9wmErxaM",
            authDomain: "typing-1124d.firebaseapp.com",
            databaseURL: "https://typing-1124d-default-rtdb.firebaseio.com",
            projectId: "typing-1124d",
            storageBucket: "typing-1124d.firebasestorage.app",
            messagingSenderId: "869820976054",
            appId: "1:869820976054:web:cda9b912219efff0ee8f17",
            measurementId: "G-PHW409K7M3"
        };

        let dbRef, wordsRef;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                dbRef = firebase.database().ref('scores');
                wordsRef = firebase.database().ref('words');
                console.log("Database initialized successfully!");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const sfx = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            play: function(freqs, type='sine') {
                if (!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = type; o.frequency.setValueAtTime(freqs, this.ctx.currentTime);
                g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime + 0.1);
            },
            correct: function() { this.init(); this.play(800); },
            error: function() { this.init(); this.play(150, 'sawtooth'); },
            success: function() { this.init(); [523,659,784].forEach((f,i)=>setTimeout(()=>this.play(f),i*100)); }
        };

        // ==========================================
        // ‚úÖ Data & Migration Logic
        // ==========================================
        const defaultData = {
            "P1": ["a ball", "a car", "a doll", "a robot", "a bus", "a teddy bear", "red", "blue", "white", "pink"],
            "P2": ["kind", "friendly", "helpful", "clever", "funny", "polite", "in front of", "behind", "between", "because"],
            "P3": ["classroom", "art room", "computer room", "music room", "library", "school hall", "lift", "toilets", "on the left", "on the right", "next to", "Where's", "Where are", "ground floor", "first floor", "second floor", "third floor", "fourth floor", "fifth floor", "sixth floor"],
            "Challenge": ["MsDiane is cool", "English is fun"]
        };

        // ==========================================
        // ‚úÖ Game Logic
        // ==========================================
        const game = {
            data: { "P1": [], "P2": [], "P3": [], "Challenge": [] },
            state: { player: {}, grade: "P1", score: 0, time: 60, playing: false, word: "", currentP1Input: "", timer: null },
            
            init: function() {
                const bind = (id, fn) => document.getElementById(id).onclick = (e) => { e.preventDefault(); fn(); };
                bind('login-btn', () => this.login());
                bind('start-btn', () => this.start());
                bind('reset-btn', () => this.reset());
                bind('rank-btn', () => this.showRank(this.state.grade));
                document.getElementById('game-input').oninput = (e) => this.input(e);
                
                this.checkAndMigrateWords();
                this.setGrade('P1');
            },

            checkAndMigrateWords: function() {
                if(!wordsRef) return;
                wordsRef.once('value', snapshot => {
                    if(!snapshot.exists()) {
                        wordsRef.child('P1').set(defaultData.P1); 
                        wordsRef.child('P2').set(defaultData.P2);
                        wordsRef.child('P3').set(defaultData.P3);
                        wordsRef.child('Challenge').set(defaultData.Challenge);
                    }
                    this.listenToWords();
                });
            },

            listenToWords: function() {
                ['P1', 'P2', 'P3', 'Challenge'].forEach(g => {
                    wordsRef.child(g).on('value', snap => {
                        const val = snap.val();
                        if (!val) {
                            this.data[g] = []; 
                        } else if (Array.isArray(val)) {
                            this.data[g] = val; 
                        } else {
                            this.data[g] = Object.values(val);
                        }
                    });
                });
            },
            
            login: function() {
                const c = document.getElementById('login-class').value.trim();
                const n = document.getElementById('login-name').value.trim();
                if(!c || !n) return alert("Ë´ãËº∏ÂÖ•Áè≠Âà•ÂíåÂßìÂêç Input class and name");
                sfx.correct();
                this.state.player = {c, n};
                document.getElementById('display-name').innerText = n;
                document.getElementById('display-class').innerText = c;
                document.getElementById('login-overlay').classList.add('hidden');
            },

            setGrade: function(g) {
                if(this.state.playing) return;
                this.state.grade = g;
                
                document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('active'));
                const btn = Array.from(document.querySelectorAll('.grade-selector .grade-btn')).find(b => b.innerText.includes(g) || (g==='Challenge' && b.classList.contains('challenge')));
                if(btn) btn.classList.add('active');
                
                if (g === 'P1') {
                    document.getElementById('typing-interface').classList.add('hidden');
                    document.getElementById('p1-interface').classList.remove('hidden');
                } else {
                    document.getElementById('typing-interface').classList.remove('hidden');
                    document.getElementById('p1-interface').classList.add('hidden');
                }
                
                document.getElementById('target-display').innerText = `${g === 'Challenge' ? 'Challenge MsDiane' : g} Get ready`;
            },

            start: function() {
                if(this.state.playing) return;
                sfx.init();
                this.state.playing = true; this.state.score = 0; this.state.time = 60;
                document.getElementById('score').innerText = 0;
                
                document.getElementById('game-input').disabled = false;
                document.getElementById('game-input').value = '';
                if(this.state.grade !== 'P1') document.getElementById('game-input').focus();
                
                document.getElementById('start-btn').disabled = true;
                document.getElementById('reset-btn').disabled = false;
                
                this.next();
                this.state.timer = setInterval(() => {
                    this.state.time--;
                    document.getElementById('timer').innerText = this.state.time;
                    if(this.state.time<=0) this.end();
                }, 1000);
            },

            reset: function() {
                clearInterval(this.state.timer);
                this.state.playing = false;
                document.getElementById('game-input').disabled = true;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('reset-btn').disabled = true;
                document.getElementById('timer').innerText = 60;
                document.getElementById('target-display').innerText = "Ê∫ñÂÇô Get Ready";
                document.getElementById('scramble-box').innerHTML = "";
            },

            next: function() {
                const list = this.data[this.state.grade];
                const pool = (list && list.length > 0) ? list : defaultData[this.state.grade] || ["Loading..."];
                
                this.state.word = pool[Math.floor(Math.random()*pool.length)];
                
                if (this.state.grade === 'P1') {
                    this.state.currentP1Input = this.state.word.charAt(0);
                    this.renderP1();
                } else {
                    this.render("");
                }
            },

            renderP1: function() {
                let slotsHtml = "";
                const cleanWord = this.state.word;
                
                for(let i=0; i<cleanWord.length; i++) {
                    const char = cleanWord[i];
                    if(char === ' ') {
                        slotsHtml += `<span style="display:inline-block;width:15px;"></span>`;
                    } else if (i === 0) {
                        slotsHtml += `<span class="p1-slot filled hint">${char}</span>`;
                    } else {
                        slotsHtml += `<span class="p1-slot"></span>`;
                    }
                }
                document.getElementById('target-display').innerHTML = slotsHtml;
                
                const container = document.getElementById('scramble-box');
                container.innerHTML = "";
                
                let chars = this.state.word.slice(1).split('').filter(c => c !== ' ').sort(() => Math.random() - 0.5);
                
                chars.forEach((char) => {
                    const btn = document.createElement('button');
                    btn.className = 'scramble-btn';
                    btn.innerText = char;
                    btn.onclick = () => this.handleP1Click(char, btn);
                    container.appendChild(btn);
                });
            },

            handleP1Click: function(char, btnElem) {
                if(!this.state.playing) return;
                
                const targetNoSpaces = this.state.word.replace(/ /g, '');
                const currentInputLen = this.state.currentP1Input.length;
                
                if(currentInputLen >= targetNoSpaces.length) return; 

                const expectedChar = targetNoSpaces[currentInputLen];
                
                if(char === expectedChar) {
                    sfx.correct();
                    this.state.currentP1Input += char;
                    btnElem.classList.add('used');
                    
                    const slots = document.querySelectorAll('.p1-slot:not(.hint)');
                    for(let s of slots) {
                        if(!s.innerText) {
                            s.innerText = char;
                            s.classList.add('filled');
                            s.classList.add('correct');
                            break;
                        }
                    }

                    if(this.state.currentP1Input === targetNoSpaces) {
                        this.state.score += 10;
                        document.getElementById('score').innerText = this.state.score;
                        sfx.success();
                        setTimeout(() => this.next(), 500);
                    }
                } else {
                    sfx.error();
                    btnElem.classList.add('error-anim');
                    setTimeout(() => btnElem.classList.remove('error-anim'), 300);
                }
            },

            render: function(val) {
                let h = "";
                for(let i=0; i<this.state.word.length; i++) {
                    let c = this.state.word[i];
                    let cls = "pending";
                    if(i < val.length) cls = val[i]===c ? "correct" : "error-anim";
                    h += `<span class="char ${cls}" style="${c===' '?'margin:0 5px;border-bottom:2px solid #ccc;width:10px;display:inline-block':''}">${c===' '?'':c}</span>`;
                }
                document.getElementById('target-display').innerHTML = h;
            },

            input: function(e) {
                if(!this.state.playing) return;
                const v = e.target.value;
                const t = this.state.word;
                if(e.inputType && e.inputType.includes('delete')) return this.render(v);
                if(v.length === 0) return this.render("");
                
                const idx = v.length - 1;
                if(idx >= t.length || v[idx] !== t[idx]) {
                    sfx.error();
                    e.target.value = v.slice(0, -1);
                    document.getElementById('target-display').classList.add('error-anim');
                    setTimeout(()=>document.getElementById('target-display').classList.remove('error-anim'), 300);
                } else {
                    sfx.correct();
                    this.render(v);
                    if(v === t) {
                        this.state.score += 10;
                        document.getElementById('score').innerText = this.state.score;
                        sfx.success();
                        setTimeout(() => { e.target.value=""; this.next(); }, 150);
                    }
                }
            },

            end: function() {
                clearInterval(this.state.timer);
                this.state.playing = false;
                document.getElementById('game-input').disabled = true;
                
                this.save();
                
                document.getElementById('final-score').innerText = this.state.score;
                document.getElementById('final-msg').innerText = `${this.state.player.n} | Good Job!`;
                document.getElementById('result-overlay').classList.remove('hidden');
            },

            save: function() {
                if(!dbRef) return;
                const now = new Date();
                dbRef.push({
                    grade: this.state.grade,
                    name: this.state.player.n,
                    class: this.state.player.c,
                    score: this.state.score,
                    date: `${now.getMonth()+1}/${now.getDate()}`,
                    time: `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            },

            showRank: function(grade) {
                document.getElementById('rank-overlay').classList.remove('hidden');
                document.querySelector('#rank-table tbody').innerHTML = "";
                document.getElementById('rank-loading').classList.remove('hidden');
                document.getElementById('rank-msg').innerText = "";
                
                document.querySelectorAll('#rank-tabs .grade-btn').forEach(b => b.classList.remove('active'));
                const targetBtn = Array.from(document.querySelectorAll('#rank-tabs .grade-btn')).find(b => b.innerText.includes(grade) || (grade === 'Challenge' && b.classList.contains('challenge')));
                if(targetBtn) targetBtn.classList.add('active');
                
                if(!dbRef) return;

                dbRef.orderByChild('grade').equalTo(grade).limitToLast(50).once('value')
                .then((snapshot) => {
                    let records = [];
                    snapshot.forEach((child) => { records.push(child.val()); });
                    records.sort((a,b) => b.score - a.score);

                    document.getElementById('rank-loading').classList.add('hidden');
                    if(records.length === 0) {
                        document.getElementById('rank-msg').innerText = `${grade} Êö´ÁÑ°Á¥ÄÈåÑ`;
                    } else {
                        // Tie Logic Implementation
                        let currentRank = 1;
                        records.forEach((r, i) => {
                            if (i > 0 && r.score < records[i-1].score) {
                                currentRank = i + 1; // Standard competition ranking: 1, 1, 3
                            }
                            
                            let icon;
                            if (currentRank === 1) icon = 'ü•á';
                            else if (currentRank === 2) icon = 'ü•à';
                            else if (currentRank === 3) icon = 'ü•â';
                            else icon = currentRank;

                            let color = currentRank===1?'gold':currentRank===2?'silver':currentRank===3?'#cd7f32':'#555';
                            
                            let row = `<tr><td style="color:${color};font-weight:bold;">${icon}</td><td>${r.class}</td><td>${r.name}</td><td style="color:var(--primary);font-weight:bold;">${r.score}</td></tr>`;
                            document.querySelector('#rank-table tbody').innerHTML += row;
                        });
                    }
                });
            },

            closeResult: function() {
                document.getElementById('result-overlay').classList.add('hidden');
                this.showRank(this.state.grade);
                this.reset();
            }
        };
        
        // ==========================================
        // ‚úÖ Admin Logic (MsDiane)
        // ==========================================
        const admin = {
            currentRankGrade: 'P1',
            currentWordGrade: 'P1',
            
            openLogin: function() {
                document.getElementById('admin-login-overlay').classList.remove('hidden');
                document.getElementById('admin-pass').value = '';
                document.getElementById('admin-pass').focus();
            },
            login: function() {
                const p = document.getElementById('admin-pass').value;
                if(p === "KliO199868") {
                    document.getElementById('admin-login-overlay').classList.add('hidden');
                    document.getElementById('admin-dash-overlay').classList.remove('hidden');
                    this.switchTab('rank');
                    this.loadRanks('P1');
                } else {
                    alert("Access Denied");
                }
            },
            close: function() {
                document.getElementById('admin-dash-overlay').classList.add('hidden');
            },
            
            switchTab: function(tabName) {
                document.querySelectorAll('.admin-panel-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.admin-tab-btn').forEach(el => el.classList.remove('active'));
                
                document.getElementById(`admin-tab-${tabName}`).classList.add('active');
                const btns = document.querySelectorAll('.admin-tab-btn');
                if(tabName === 'rank') btns[0].classList.add('active');
                if(tabName === 'word') {
                    btns[1].classList.add('active');
                    this.loadWords('P1');
                }
            },

            loadRanks: function(grade) {
                this.currentRankGrade = grade;
                document.getElementById('admin-rank-status').innerText = `Viewing: ${grade}`;
                const tbody = document.querySelector('#admin-rank-table tbody');
                tbody.innerHTML = '<tr><td colspan="6"><div class="spinner" style="width:20px;height:20px;border-width:2px;margin:5px auto;"></div></td></tr>';
                
                // FORCE READ ALL: Removed any .limitToLast() constraints
                let query;
                if(grade === 'ALL') {
                    // Directly read root to ensure nothing is missed
                    query = dbRef; 
                } else {
                    query = dbRef.orderByChild('grade').equalTo(grade);
                }

                query.once('value', snap => {
                    tbody.innerHTML = "";
                    if(!snap.exists()) { tbody.innerHTML = "<tr><td colspan='6'>No data</td></tr>"; return; }
                    
                    let data = [];
                    // Force loop over all children
                    snap.forEach(c => {
                        const val = c.val();
                        // For 'ALL', the structure might be flat, for equalTo it's filtered
                        // We check if it has the basic fields to ensure it's a record
                        if(val && val.name && val.score !== undefined) {
                            // If filtering by ALL, push everything. If specific grade, the query handled it.
                            if(grade === 'ALL' || val.grade === grade) {
                                data.push({key: c.key, ...val});
                            }
                        }
                    });
                    
                    data.sort((a,b) => b.score - a.score); 
                    
                    data.forEach(r => {
                        const tr = document.createElement('tr');
                        const dt = `${r.date || '-'} ${r.time || ''}`;
                        tr.innerHTML = `<td>${r.grade}</td><td>${r.class}</td><td>${r.name}</td><td>${r.score}</td><td style="font-size:0.8rem;color:#666;">${dt}</td><td><button class="btn-sm btn-del" onclick="admin.delRank('${r.key}')">X</button></td>`;
                        tbody.appendChild(tr);
                    });
                });
            },
            delRank: function(key) {
                if(confirm("Confirm delete?")) {
                    dbRef.child(key).remove().then(() => this.loadRanks(this.currentRankGrade));
                }
            },
            clearAllRanks: function() {
                if(confirm(`‚ö†Ô∏è WARNING: DELETE ALL ${this.currentRankGrade} records? This cannot be undone.`)) {
                    const grade = this.currentRankGrade;
                    if (grade === 'ALL') {
                         if(confirm("REALLY delete EVERYTHING (All Grades)?")) {
                             dbRef.remove().then(() => { alert("Cleared DB."); this.loadRanks('ALL'); });
                         }
                    } else {
                        dbRef.orderByChild('grade').equalTo(grade).once('value', snap => {
                            const updates = {};
                            snap.forEach(c => updates[c.key] = null);
                            dbRef.update(updates).then(() => {
                                alert("Cleared.");
                                this.loadRanks(grade);
                            });
                        });
                    }
                }
            },

            loadWords: function(grade) {
                this.currentWordGrade = grade;
                document.getElementById('admin-word-status').innerText = `Editing: ${grade}`;
                const tbody = document.querySelector('#admin-word-table tbody');
                tbody.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';
                
                wordsRef.child(grade).once('value', snap => {
                    tbody.innerHTML = "";
                    if(!snap.exists()) { tbody.innerHTML = "<tr><td colspan='2'>No words found</td></tr>"; return; }
                    
                    const val = snap.val();
                    let items = [];
                    if(Array.isArray(val)) {
                        val.forEach((w, i) => items.push({key: i, val: w}));
                    } else {
                        Object.keys(val).forEach(k => items.push({key: k, val: val[k]}));
                    }

                    items.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td style="text-align:left;">${item.val}</td><td><button class="btn-sm btn-del" onclick="admin.delWord('${item.key}')">X</button></td>`;
                        tbody.appendChild(tr);
                    });
                });
            },
            addWord: function() {
                const w = document.getElementById('new-word-input').value.trim();
                if(w) {
                    wordsRef.child(this.currentWordGrade).push(w).then(() => {
                        document.getElementById('new-word-input').value = "";
                        this.loadWords(this.currentWordGrade);
                    });
                }
            },
            delWord: function(key) {
                if(confirm("Delete this word?")) {
                    wordsRef.child(this.currentWordGrade).child(key).remove().then(() => this.loadWords(this.currentWordGrade));
                }
            }
        };

        window.onload = () => game.init();
    </script>
</body>
</html>
