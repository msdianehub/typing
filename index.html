<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ ¡åœ’è‹±èªæ‰“å­—ç·´ç¿’ (Realtime DBç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* CSS æ¨£å¼ä¿æŒä¸è®Šï¼Œç¶­æŒæ‰‹æ©Ÿå„ªåŒ– */
        :root { --primary: #4ecdc4; --secondary: #ff6b6b; --dark: #1a535c; --accent: #ffd166; --p1-color: #ff9f43; --p2-color: #54a0ff; --p3-color: #5f27cd; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Comic Sans MS', sans-serif; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-x: hidden; overscroll-behavior: none;}
        .container { background-color: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 100%; max-width: 900px; padding: 20px; text-align: center; border: 4px solid #fff; position: relative; }
        h1 { color: var(--dark); margin-bottom: 10px; font-size: 1.8rem; }
        .info-header { display: flex; flex-direction: column; gap: 10px; background-color: #f1f2f6; padding: 10px; border-radius: 12px; margin-bottom: 15px; }
        .player-info { font-size: 1rem; color: var(--dark); font-weight: bold; }
        .game-stats { display: flex; justify-content: center; gap: 10px; font-size: 1.1rem; font-weight: bold; }
        .grade-selector { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .grade-btn { padding: 8px 16px; font-size: 1rem; border: none; border-radius: 20px; cursor: pointer; color: white; opacity: 0.6; }
        .grade-btn.p1 { background: var(--p1-color); } .grade-btn.p2 { background: var(--p2-color); } .grade-btn.p3 { background: var(--p3-color); }
        .grade-btn.active { opacity: 1; transform: scale(1.05); outline: 2px solid var(--dark); }
        .target-box { background: #fff; border: 3px dashed var(--dark); border-radius: 12px; padding: 15px; margin: 10px 0; min-height: 100px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap; font-size: 2rem; font-family: 'Courier New', monospace; word-break: break-word; }
        .char { margin: 0 1px; } .char-space { margin: 0 4px; border-bottom: 2px solid #ddd; width: 15px; display: inline-block; }
        .correct { color: var(--primary); } .error-anim { color: var(--secondary); animation: shake 0.3s; } .pending { color: #ccc; }
        #game-input { width: 100%; padding: 10px; font-size: 1.5rem; text-align: center; border: 3px solid #ccc; border-radius: 10px; outline: none; background: #f9f9f9; -webkit-user-select: text; user-select: text; }
        #game-input:focus { border-color: var(--primary); background: #fff; }
        .controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; font-size: 1rem; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; }
        .btn-start { background: var(--primary); width: 100%; max-width: 200px; } .btn-reset { background: var(--secondary); } .btn-rank { background: var(--dark); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
        .hidden { display: none !important; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 500px; text-align: center; border: 4px solid var(--accent); position: relative;}
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; -webkit-user-select: text; user-select: text; }
        .level-selector { margin: 5px 0 15px 0; min-height: 35px; display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; }
        .level-btn { background: #eee; border: 2px solid #ccc; padding: 6px 14px; border-radius: 15px; font-weight: bold; color: #777; font-size: 0.9rem; }
        .level-btn.active { background: var(--dark); color: white; border-color: var(--dark); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; } th { background: #eee; padding: 8px; white-space: nowrap;} td { padding: 8px 4px; border-bottom: 1px solid #eee; }
        
        /* Loading å‹•ç•« */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

    <div class="modal-overlay" id="login-overlay">
        <div class="modal-box">
            <h2 style="color: var(--secondary); margin-bottom: 15px;">ğŸ‘‹ æ­¡è¿ä¾†åˆ°æ‰“å­—ç·´ç¿’</h2>
            <input type="text" class="login-input" id="login-class" placeholder="ç­åˆ¥ (Class): 1A" autocorrect="off">
            <input type="text" class="login-input" id="login-name" placeholder="å§“å (Name): é™³å°æ˜" autocorrect="off">
            <button class="btn btn-start" id="login-btn" style="margin-top: 15px;">é€²å…¥ç·´ç¿’</button>
        </div>
    </div>

    <div class="container">
        <h1>ğŸ« æ ¡åœ’è‹±èªæ‰“å­—ç·´ç¿’</h1>
        <div class="info-header">
            <div class="player-info">å­¸ç”Ÿ: <span id="display-name">---</span> (<span id="display-class">---</span>)</div>
            <div class="game-stats">
                <div style="background:white;padding:5px 10px;border-radius:8px;">å¾—åˆ†: <span id="score">0</span></div>
                <div style="background:white;padding:5px 10px;border-radius:8px;">æ™‚é–“: <span id="timer">60</span>s</div>
            </div>
        </div>
        <div class="grade-selector">
            <button class="grade-btn p1 active" onclick="game.setGrade('P1')">P1 ä¸€å¹´ç´š</button>
            <button class="grade-btn p2" onclick="game.setGrade('P2')">P2 äºŒå¹´ç´š</button>
            <button class="grade-btn p3" onclick="game.setGrade('P3')">P3 ä¸‰å¹´ç´š</button>
        </div>
        <div class="level-selector" id="level-container"></div>
        <div class="target-box" id="target-display">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
        <div style="margin-top: 15px;">
            <input type="text" id="game-input" placeholder="é»æ“Šé–‹å§‹å¾Œè¼¸å…¥..." disabled autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>
        <div class="controls">
            <button class="btn btn-start" id="start-btn">é–‹å§‹éŠæˆ²</button>
            <button class="btn btn-reset" id="reset-btn" disabled>é‡ç½®</button>
            <button class="btn btn-rank" id="rank-btn">ğŸ† é›²ç«¯æ’è¡Œæ¦œ</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="rank-overlay">
        <div class="modal-box">
            <h2>ğŸ† é›²ç«¯æ’è¡Œæ¦œ</h2>
            <div style="margin-bottom:10px; display:flex; justify-content:center; gap:5px;" id="rank-tabs">
                <button class="grade-btn p1" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P1')">P1æ¦œ</button>
                <button class="grade-btn p2" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P2')">P2æ¦œ</button>
                <button class="grade-btn p3" style="font-size:0.8rem; padding:5px 10px;" onclick="game.showRank('P3')">P3æ¦œ</button>
            </div>
            
            <div id="rank-loading" class="hidden"><div class="spinner"></div></div>
            <div id="rank-msg" style="color:#666; font-size:0.9rem; margin:10px 0;"></div>
            
            <div style="max-height: 250px; overflow-y: auto;">
                <table id="rank-table"><thead><tr><th>#</th><th>ç­</th><th>å</th><th>åˆ†</th><th>æ—¥</th><th>æ™‚</th></tr></thead><tbody></tbody></table>
            </div>
            <button class="btn btn-start" style="margin-top: 15px;" onclick="document.getElementById('rank-overlay').classList.add('hidden')">é—œé–‰</button>
        </div>
    </div>

    <div class="modal-overlay hidden" id="result-overlay">
        <div class="modal-box">
            <h2>â° æ™‚é–“åˆ°ï¼</h2>
            <div style="font-size: 3.5rem; color: var(--secondary); margin: 10px 0;" id="final-score">0</div>
            <p id="final-msg" style="margin-bottom: 20px; font-weight:bold;"></p>
            <button class="btn btn-start" onclick="game.closeResult()">æŸ¥çœ‹æ’å</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”¥ è«‹å‹™å¿…æ›´æ–° Config (å« databaseURL) ğŸ”¥
        // ==========================================
        const firebaseConfig = {
            apiKey: "è«‹è²¼ä¸ŠAPIKey",
            authDomain: "ä½ çš„project.firebaseapp.com",
            // ğŸ”¥ Realtime DB å¿…é ˆè¦æœ‰é€™å€‹ URLï¼Œé€šå¸¸æ˜¯ https://xxx.firebaseio.com
            databaseURL: "è«‹è²¼ä¸Šä½ çš„DatabaseURL", 
            projectId: "ä½ çš„project-id",
            storageBucket: "ä½ çš„project.appspot.com",
            messagingSenderId: "ID",
            appId: "AppID"
        };

        let dbRef;
        try {
            if (!firebase.apps.length) {
                if(!firebaseConfig.databaseURL || firebaseConfig.databaseURL.includes("è«‹è²¼ä¸Š")) {
                    alert("éŒ¯èª¤ï¼šè«‹åœ¨ HTML ä»£ç¢¼ä¸­å¡«å¯« databaseURLï¼");
                } else {
                    firebase.initializeApp(firebaseConfig);
                    // ğŸ”¥ ä½¿ç”¨ database() è€Œä¸æ˜¯ firestore()
                    dbRef = firebase.database().ref('scores');
                    console.log("Realtime DB initialized");
                }
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
            alert("è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Config");
        }

        const sfx = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            play: function(freqs, type='sine') {
                if (!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = type; o.frequency.setValueAtTime(freqs, this.ctx.currentTime);
                g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime + 0.1);
            },
            correct: function() { this.init(); this.play(800); },
            error: function() { this.init(); this.play(150, 'sawtooth'); },
            success: function() { this.init(); [523,659,784].forEach((f,i)=>setTimeout(()=>this.play(f),i*100)); }
        };

        const game = {
            data: {
                "P1": { levels: {1: ["a ball", "a car", "a doll", "a robot", "a bus", "a teddy bear", "red", "blue", "white", "pink"]}, hasSub: false },
                "P2": { levels: {1: ["kind", "friendly", "helpful", "clever", "funny", "polite", "in front of", "behind", "between", "because"]}, hasSub: false },
                "P3": { levels: {
                    1: ["classroom", "art room", "computer room", "music room", "library", "school hall", "lift", "toilets"],
                    2: ["on the left", "on the right", "next to", "Where's", "Where are"],
                    3: ["ground floor", "first floor", "second floor", "third floor", "fourth floor", "fifth floor", "sixth floor"]
                }, hasSub: true }
            },
            state: { player: {}, grade: "P1", level: 1, score: 0, time: 60, playing: false, word: "", timer: null },
            
            init: function() {
                // ç¶å®šäº‹ä»¶
                const bind = (id, fn) => document.getElementById(id).onclick = (e) => { e.preventDefault(); fn(); };
                bind('login-btn', () => this.login());
                bind('start-btn', () => this.start());
                bind('reset-btn', () => this.reset());
                bind('rank-btn', () => this.showRank(this.state.grade));
                document.getElementById('game-input').oninput = (e) => this.input(e);
                this.setGrade('P1');
            },
            
            login: function() {
                const c = document.getElementById('login-class').value.trim();
                const n = document.getElementById('login-name').value.trim();
                if(!c || !n) return alert("è«‹è¼¸å…¥ç­åˆ¥å’Œå§“å");
                sfx.correct();
                this.state.player = {c, n};
                document.getElementById('display-name').innerText = n;
                document.getElementById('display-class').innerText = c;
                document.getElementById('login-overlay').classList.add('hidden');
            },

            setGrade: function(g) {
                if(this.state.playing) return;
                this.state.grade = g; this.state.level = 1;
                document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`.grade-btn.${g.toLowerCase()}`).forEach(b => b.classList.add('active'));
                
                const box = document.getElementById('level-container');
                box.innerHTML = '';
                if(this.data[g].hasSub) {
                    [1,2,3].forEach(l => {
                        const b = document.createElement('button');
                        b.className = `level-btn ${l===1?'active':''}`;
                        b.innerText = `Level ${l}`;
                        b.onclick = (e) => { e.preventDefault(); if(!this.state.playing) { this.state.level=l; document.querySelectorAll('.level-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }};
                        box.appendChild(b);
                    });
                } else { box.innerHTML = '<span style="color:#999">(ç¶œåˆç·´ç¿’)</span>'; }
                document.getElementById('target-display').innerText = `${g} æº–å‚™`;
            },

            start: function() {
                if(this.state.playing) return;
                sfx.init();
                this.state.playing = true; this.state.score = 0; this.state.time = 60;
                document.getElementById('score').innerText = 0;
                document.getElementById('game-input').disabled = false;
                document.getElementById('game-input').value = '';
                document.getElementById('game-input').focus();
                document.getElementById('start-btn').disabled = true;
                document.getElementById('reset-btn').disabled = false;
                this.next();
                this.state.timer = setInterval(() => {
                    this.state.time--;
                    document.getElementById('timer').innerText = this.state.time;
                    if(this.state.time<=0) this.end();
                }, 1000);
            },

            reset: function() {
                clearInterval(this.state.timer);
                this.state.playing = false;
                document.getElementById('game-input').disabled = true;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('reset-btn').disabled = true;
                document.getElementById('timer').innerText = 60;
                document.getElementById('target-display').innerText = "æº–å‚™";
            },

            next: function() {
                const list = this.data[this.state.grade].levels[this.state.level];
                this.state.word = list[Math.floor(Math.random()*list.length)];
                this.render("");
            },

            render: function(val) {
                let h = "";
                for(let i=0; i<this.state.word.length; i++) {
                    let c = this.state.word[i];
                    let cls = "pending";
                    if(i < val.length) cls = val[i]===c ? "correct" : "error-anim";
                    h += `<span class="char ${cls}" style="${c===' '?'margin:0 5px;border-bottom:2px solid #ccc;width:10px;display:inline-block':''}">${c===' '?'':c}</span>`;
                }
                document.getElementById('target-display').innerHTML = h;
            },

            input: function(e) {
                if(!this.state.playing) return;
                const v = e.target.value;
                const t = this.state.word;
                if(e.inputType && e.inputType.includes('delete')) return this.render(v);
                if(v.length === 0) return this.render("");
                
                const idx = v.length - 1;
                if(idx >= t.length || v[idx] !== t[idx]) {
                    sfx.error();
                    e.target.value = v.slice(0, -1);
                    document.getElementById('target-display').classList.add('error-anim');
                    setTimeout(()=>document.getElementById('target-display').classList.remove('error-anim'), 300);
                } else {
                    sfx.correct();
                    this.render(v);
                    if(v === t) {
                        this.state.score += 10;
                        document.getElementById('score').innerText = this.state.score;
                        sfx.success();
                        setTimeout(() => { e.target.value=""; this.next(); }, 150);
                    }
                }
            },

            end: function() {
                clearInterval(this.state.timer);
                this.state.playing = false;
                document.getElementById('game-input').disabled = true;
                
                this.save();
                
                document.getElementById('final-score').innerText = this.state.score;
                document.getElementById('final-msg').innerText = `${this.state.player.n} | è¡¨ç¾ä¸éŒ¯å–”ï¼`;
                document.getElementById('result-overlay').classList.remove('hidden');
            },

            // ğŸ”¥ Realtime DB å„²å­˜é‚è¼¯
            save: function() {
                if(!dbRef) return;
                const now = new Date();
                dbRef.push({
                    grade: this.state.grade,
                    name: this.state.player.n,
                    class: this.state.player.c,
                    score: this.state.score,
                    date: `${now.getMonth()+1}/${now.getDate()}`,
                    time: `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            },

            // ğŸ”¥ Realtime DB è®€å–é‚è¼¯
            showRank: function(grade) {
                document.getElementById('rank-overlay').classList.remove('hidden');
                document.querySelector('#rank-table tbody').innerHTML = "";
                document.getElementById('rank-loading').classList.remove('hidden');
                document.getElementById('rank-msg').innerText = "";
                
                if(!dbRef) {
                    document.getElementById('rank-loading').classList.add('hidden');
                    document.getElementById('rank-msg').innerText = "è³‡æ–™åº«æœªé€£æ¥";
                    return;
                }

                // åœ¨ Realtime DB æ ¹æ“š Grade æŠ“è³‡æ–™
                dbRef.orderByChild('grade').equalTo(grade).once('value')
                .then((snapshot) => {
                    let records = [];
                    snapshot.forEach((child) => {
                        records.push(child.val());
                    });
                    
                    // å‰ç«¯æ’åº (åˆ†æ•¸é«˜ -> ä½)
                    records.sort((a,b) => b.score - a.score);
                    // å–å‰ 50
                    records = records.slice(0, 50);

                    document.getElementById('rank-loading').classList.add('hidden');
                    if(records.length === 0) {
                        document.getElementById('rank-msg').innerText = `${grade} æš«ç„¡ç´€éŒ„`;
                    } else {
                        records.forEach((r, i) => {
                            let c = i===0?'gold':i===1?'silver':i===2?'#cd7f32':'#555';
                            let icon = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':(i+1);
                            let row = `<tr><td style="color:${c};font-weight:bold;">${icon}</td><td>${r.class}</td><td>${r.name}</td><td style="color:var(--primary);font-weight:bold;">${r.score}</td><td>${r.date}</td><td>${r.time}</td></tr>`;
                            document.querySelector('#rank-table tbody').innerHTML += row;
                        });
                    }
                })
                .catch(e => {
                    console.error(e);
                    document.getElementById('rank-loading').classList.add('hidden');
                    document.getElementById('rank-msg').innerText = "è®€å–å¤±æ•—";
                });
            },

            closeResult: function() {
                document.getElementById('result-overlay').classList.add('hidden');
                this.showRank(this.state.grade);
                this.reset();
            }
        };

        window.onload = () => game.init();
    </script>
</body>
</html>
